# Система ролей и прав доступа к админ-панели

## Роли пользователей

В системе существует 4 роли пользователей:

### 1. USER (Пользователь)
- Обычные пользователи сайта
- Не имеют доступа к админ-панели
- Могут пользоваться функциями личного кабинета

### 2. OPERATOR (Оператор)
- **Доступ к админ-панели**: Только раздел "Чат"
- Может отвечать на сообщения пациентов в чате
- Не имеет доступа к другим разделам админ-панели
- Видит щит админки в навигации

### 3. ADMIN (Администратор)
- **Доступ к админ-панели**: Все разделы кроме "Письма"
- Может управлять контентом сайта
- **НЕ МОЖЕТ**:
  - Назначать других администраторов
  - Снимать права администратора
  - Изменять роль существующих администраторов
  - Просматривать письма главному врачу
- Видит щит админки в навигации

### 4. CHIEF_DOCTOR (Главный врач)
- **Доступ к админ-панели**: Все разделы без исключений
- **МОЖЕТ**:
  - Назначать и снимать администраторов (требует подтверждение пароля)
  - Управлять всеми пользователями
  - Просматривать и отвечать на письма пациентов
  - Делать всё, что могут другие роли
- Видит щит админки в навигации

## Разделы админ-панели и доступ

| Раздел | Оператор | Администратор | Главный врач |
|--------|----------|---------------|--------------|
| Чат | ✅ | ✅ | ✅ |
| Специалисты | ❌ | ✅ | ✅ |
| Услуги | ❌ | ✅ | ✅ |
| Материалы | ❌ | ✅ | ✅ |
| Партнёры | ❌ | ✅ | ✅ |
| Вакансии | ❌ | ✅ | ✅ |
| Вопросы (FAQ) | ❌ | ✅ | ✅ |
| Отзывы | ❌ | ✅ | ✅ |
| Контакты | ❌ | ✅ | ✅ |
| Письма | ❌ | ❌ | ✅ |
| Пользователи | ❌ | ✅* | ✅ |

*Администратор может управлять пользователями, но не может назначать/снимать других администраторов

## Управление пользователями

### Назначение ролей

#### Оператор
- **Кто может назначить**: Администратор или Главный врач
- **Требуется**: Нет дополнительных проверок

#### Администратор
- **Кто может назначить**: Только Главный врач
- **Требуется**: Подтверждение пароля главного врача
- **Ограничения**: Администратор НЕ может назначать других администраторов

#### Главный врач
- **Кто может назначить**: Никто
- **Роль главного врача не может быть изменена**

### Снятие ролей

- Администратор может снимать роли OPERATOR и возвращать пользователей в статус USER
- Администратор НЕ может снимать роль с других администраторов
- Только Главный врач может снимать роль администратора
- Роль Главного врача не может быть снята

## Техническая реализация

### Файлы

1. **`src/utils/auth.ts`** - Утилиты для проверки ролей
   - `hasAdminAccess()` - проверка базового доступа к админке
   - `hasFullAdminAccess()` - полный доступ (не оператор)
   - `canManageAdmins()` - право управлять администраторами
   - `isChatOnlyAccess()` - только доступ к чату

2. **`src/utils/api-auth.ts`** - Утилиты для API роутов
   - `checkAdminAccess()` - базовая проверка для API
   - `checkFullAdminAccess()` - проверка полного доступа
   - `checkChatAccess()` - проверка для чата
   - `checkAdminManagementAccess()` - проверка прав на управление админами

3. **`src/middleware.ts`** - Защита роутов на уровне Next.js
   - Проверяет доступ к `/admin` роутам
   - Редиректит операторов на `/admin/chat`
   - Блокирует неавторизованных пользователей

4. **`src/types/next-auth.d.ts`** - TypeScript типы для NextAuth
   - Расширяет Session с полем `role`
   - Определяет типы ролей

5. **`src/app/api/admin/auth/route.ts`** - API проверки прав
   - GET: возвращает информацию о правах текущего пользователя
   - POST: проверка пароля админ-панели

## Щит админки в навигации

Щит админки отображается в header сайта только для пользователей с ролями:
- OPERATOR
- ADMIN
- CHIEF_DOCTOR

Реализовано в компоненте `SMProfileButton` (src/components/common/SMProfileButton/SMProfileButton.tsx)

## Безопасность

1. **Проверка на уровне middleware** - блокирует доступ до рендеринга страницы
2. **Проверка в API роутах** - защищает серверные операции
3. **Проверка в UI** - скрывает недоступные элементы интерфейса
4. **Подтверждение пароля** - для критических операций (назначение админа)

## Примеры использования

### В API роуте
```typescript
import { checkFullAdminAccess } from "@/utils/api-auth";

export async function GET(request: NextRequest) {
  const adminCheck = await checkFullAdminAccess(request);
  if (!adminCheck.isAdmin) {
    return NextResponse.json({ error: adminCheck.error }, { status: 403 });
  }

  // Ваш код...
}
```

### В компоненте
```typescript
import { useSession } from "next-auth/react";
import { hasFullAdminAccess } from "@/utils/auth";

const { data: session } = useSession();
const canAccess = hasFullAdminAccess(session?.user?.role);
```
