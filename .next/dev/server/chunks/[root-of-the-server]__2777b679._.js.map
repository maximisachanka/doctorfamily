{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Study/commercial-projects/smartmedical/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],\n  });\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\n\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 71, "column": 0}, "map": {"version":3,"sources":["file:///C:/Study/commercial-projects/smartmedical/src/app/api/auth/check-unique/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\n\n/**\n * Check if login or phone is already taken\n * GET /api/auth/check-unique?login=xxx or ?phone=xxx\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const searchParams = request.nextUrl.searchParams;\n    const login = searchParams.get('login');\n    const phone = searchParams.get('phone');\n    const email = searchParams.get('email');\n    const excludeId = searchParams.get('excludeId'); // For profile updates\n\n    if (!login && !phone && !email) {\n      return NextResponse.json(\n        { error: \"Укажите login, phone или email для проверки\" },\n        { status: 400 }\n      );\n    }\n\n    const excludeCondition = excludeId\n      ? { id: { not: parseInt(excludeId) } }\n      : {};\n\n    // Check login uniqueness\n    if (login) {\n      const existingLogin = await prisma.patient.findFirst({\n        where: {\n          login: login,\n          ...excludeCondition,\n        },\n      });\n\n      return NextResponse.json({\n        field: 'login',\n        value: login,\n        isUnique: !existingLogin,\n        message: existingLogin ? 'Этот логин уже занят' : null,\n      });\n    }\n\n    // Check phone uniqueness\n    if (phone) {\n      // Normalize phone - keep only digits\n      const normalizedPhone = phone.replace(/\\D/g, '');\n      const last9Digits = normalizedPhone.slice(-9);\n\n      // Получаем все телефоны и проверяем после нормализации\n      // (для совместимости со старыми данными в разных форматах)\n      const allPatients = await prisma.patient.findMany({\n        where: excludeCondition,\n        select: { id: true, phone: true },\n      });\n\n      const existingPhone = allPatients.find(patient => {\n        const patientNormalized = patient.phone.replace(/\\D/g, '');\n        // Проверяем полное совпадение или совпадение последних 9 цифр\n        return patientNormalized === normalizedPhone ||\n               patientNormalized.slice(-9) === last9Digits;\n      });\n\n      return NextResponse.json({\n        field: 'phone',\n        value: phone,\n        isUnique: !existingPhone,\n        message: existingPhone ? 'Этот номер телефона уже зарегистрирован' : null,\n      });\n    }\n\n    // Check email uniqueness\n    if (email) {\n      const existingEmail = await prisma.patient.findFirst({\n        where: {\n          email: email.toLowerCase(),\n          ...excludeCondition,\n        },\n      });\n\n      return NextResponse.json({\n        field: 'email',\n        value: email,\n        isUnique: !existingEmail,\n        message: existingEmail ? 'Этот email уже зарегистрирован' : null,\n      });\n    }\n\n    return NextResponse.json({ error: \"Неизвестная ошибка\" }, { status: 400 });\n  } catch (error) {\n    return NextResponse.json(\n      { error: \"Ошибка при проверке уникальности\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAMO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,eAAe,QAAQ,OAAO,CAAC,YAAY;QACjD,MAAM,QAAQ,aAAa,GAAG,CAAC;QAC/B,MAAM,QAAQ,aAAa,GAAG,CAAC;QAC/B,MAAM,QAAQ,aAAa,GAAG,CAAC;QAC/B,MAAM,YAAY,aAAa,GAAG,CAAC,cAAc,sBAAsB;QAEvE,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,OAAO;YAC9B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA8C,GACvD;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,mBAAmB,YACrB;YAAE,IAAI;gBAAE,KAAK,SAAS;YAAW;QAAE,IACnC,CAAC;QAEL,yBAAyB;QACzB,IAAI,OAAO;YACT,MAAM,gBAAgB,MAAM,gIAAM,CAAC,OAAO,CAAC,SAAS,CAAC;gBACnD,OAAO;oBACL,OAAO;oBACP,GAAG,gBAAgB;gBACrB;YACF;YAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;gBACP,OAAO;gBACP,UAAU,CAAC;gBACX,SAAS,gBAAgB,yBAAyB;YACpD;QACF;QAEA,yBAAyB;QACzB,IAAI,OAAO;YACT,qCAAqC;YACrC,MAAM,kBAAkB,MAAM,OAAO,CAAC,OAAO;YAC7C,MAAM,cAAc,gBAAgB,KAAK,CAAC,CAAC;YAE3C,uDAAuD;YACvD,2DAA2D;YAC3D,MAAM,cAAc,MAAM,gIAAM,CAAC,OAAO,CAAC,QAAQ,CAAC;gBAChD,OAAO;gBACP,QAAQ;oBAAE,IAAI;oBAAM,OAAO;gBAAK;YAClC;YAEA,MAAM,gBAAgB,YAAY,IAAI,CAAC,CAAA;gBACrC,MAAM,oBAAoB,QAAQ,KAAK,CAAC,OAAO,CAAC,OAAO;gBACvD,8DAA8D;gBAC9D,OAAO,sBAAsB,mBACtB,kBAAkB,KAAK,CAAC,CAAC,OAAO;YACzC;YAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;gBACP,OAAO;gBACP,UAAU,CAAC;gBACX,SAAS,gBAAgB,4CAA4C;YACvE;QACF;QAEA,yBAAyB;QACzB,IAAI,OAAO;YACT,MAAM,gBAAgB,MAAM,gIAAM,CAAC,OAAO,CAAC,SAAS,CAAC;gBACnD,OAAO;oBACL,OAAO,MAAM,WAAW;oBACxB,GAAG,gBAAgB;gBACrB;YACF;YAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;gBACP,OAAO;gBACP,UAAU,CAAC;gBACX,SAAS,gBAAgB,mCAAmC;YAC9D;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAqB,GAAG;YAAE,QAAQ;QAAI;IAC1E,EAAE,OAAO,OAAO;QACd,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAmC,GAC5C;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}