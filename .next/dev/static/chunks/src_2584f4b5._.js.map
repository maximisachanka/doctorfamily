{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Study/commercial-projects/smartmedical/src/hooks/useChiefDoctorNotifications.ts"],"sourcesContent":["'use client';\r\n\r\nimport { useEffect, useRef, useCallback } from 'react';\r\nimport { useSession } from 'next-auth/react';\r\nimport { useAlert } from '@/components/common/SMAlert/AlertProvider';\r\n\r\nconst NOTIFICATION_CHECK_INTERVAL = 30000; // 30 секунд\r\nconst NOTIFIED_LETTERS_KEY = 'chief-doctor-notifications-notified';\r\n\r\ninterface UnreadLetter {\r\n  id: number;\r\n  subject: string;\r\n  has_new_patient_message: boolean;\r\n  is_read: boolean;\r\n  patient: {\r\n    id: number;\r\n    name: string;\r\n  };\r\n}\r\n\r\nexport function useChiefDoctorNotifications() {\r\n  const { data: session, status } = useSession();\r\n  const alert = useAlert();\r\n  const intervalRef = useRef<NodeJS.Timeout | null>(null);\r\n  const audioRef = useRef<HTMLAudioElement | null>(null);\r\n\r\n  // Инициализация аудио элемента\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined') {\r\n      audioRef.current = new Audio('/sounds/notification.mp3');\r\n      audioRef.current.volume = 0.5;\r\n    }\r\n  }, []);\r\n\r\n  const playNotificationSound = useCallback(() => {\r\n    if (audioRef.current) {\r\n      audioRef.current.currentTime = 0;\r\n      audioRef.current.play().catch(() => {\r\n        // Audio play failed - browser may block autoplay\r\n      });\r\n    }\r\n  }, []);\r\n\r\n  const checkForUnreadLetters = useCallback(async () => {\r\n    // Проверяем только если пользователь - главный врач\r\n    if (status !== 'authenticated' || !session) return;\r\n\r\n    // @ts-expect-error - role может быть undefined\r\n    const userRole = session?.user?.role;\r\n    if (userRole !== 'CHIEF_DOCTOR') return;\r\n\r\n    try {\r\n      const response = await fetch('/api/admin/letters/unread');\r\n      if (!response.ok) return;\r\n\r\n      const data = await response.json();\r\n      const unreadLetters: UnreadLetter[] = data.letters || [];\r\n\r\n      if (unreadLetters.length === 0) return;\r\n\r\n      // Получаем список уже уведомленных писем\r\n      const notifiedLetters = JSON.parse(\r\n        localStorage.getItem(NOTIFIED_LETTERS_KEY) || '[]'\r\n      ) as number[];\r\n\r\n      // Находим новые непрочитанные письма (ещё не уведомляли)\r\n      const newLetters = unreadLetters.filter(\r\n        (letter) => !notifiedLetters.includes(letter.id)\r\n      );\r\n\r\n      // Письма с новыми сообщениями от пациентов\r\n      const lettersWithNewMessages = unreadLetters.filter(\r\n        (letter) => letter.has_new_patient_message && !notifiedLetters.includes(letter.id + 10000) // +10000 чтобы различать новые письма от новых сообщений\r\n      );\r\n\r\n      const hasNewNotifications = newLetters.length > 0 || lettersWithNewMessages.length > 0;\r\n\r\n      if (hasNewNotifications) {\r\n        // Воспроизводим звук уведомления\r\n        playNotificationSound();\r\n\r\n        // Показываем уведомление\r\n        const newLettersCount = newLetters.filter(l => !l.is_read && !l.has_new_patient_message).length;\r\n        const newMessagesCount = lettersWithNewMessages.length;\r\n\r\n        if (newLettersCount > 0 && newMessagesCount > 0) {\r\n          alert.info(\r\n            `У вас ${newLettersCount} новых писем и ${newMessagesCount} новых ответов от пациентов. Просмотрите админ-панель.`,\r\n            'Новые сообщения'\r\n          );\r\n        } else if (newLettersCount > 0) {\r\n          alert.info(\r\n            newLettersCount === 1\r\n              ? `Новое письмо от пациента \"${newLetters[0].patient.name}\". Просмотрите админ-панель.`\r\n              : `У вас ${newLettersCount} новых писем от пациентов. Просмотрите админ-панель.`,\r\n            'Новые письма'\r\n          );\r\n        } else if (newMessagesCount > 0) {\r\n          alert.info(\r\n            newMessagesCount === 1\r\n              ? `Новый ответ от пациента \"${lettersWithNewMessages[0].patient.name}\" в переписке. Просмотрите админ-панель.`\r\n              : `У вас ${newMessagesCount} новых ответов от пациентов. Просмотрите админ-панель.`,\r\n            'Новые ответы'\r\n          );\r\n        }\r\n\r\n        // Отмечаем письма как уведомленные\r\n        const updatedNotified = [\r\n          ...notifiedLetters,\r\n          ...newLetters.map((l) => l.id),\r\n          ...lettersWithNewMessages.map((l) => l.id + 10000),\r\n        ];\r\n        localStorage.setItem(\r\n          NOTIFIED_LETTERS_KEY,\r\n          JSON.stringify(updatedNotified)\r\n        );\r\n      }\r\n    } catch (error) {\r\n      console.error('Error checking for chief doctor notifications:', error);\r\n    }\r\n  }, [session, status, alert, playNotificationSound]);\r\n\r\n  // Проверка при первом входе или возврате на сайт\r\n  useEffect(() => {\r\n    if (status !== 'authenticated') return;\r\n\r\n    // @ts-expect-error - role может быть undefined\r\n    const userRole = session?.user?.role;\r\n    if (userRole !== 'CHIEF_DOCTOR') return;\r\n\r\n    // Небольшая задержка для загрузки страницы\r\n    const initialCheckTimeout = setTimeout(() => {\r\n      checkForUnreadLetters();\r\n    }, 2000);\r\n\r\n    return () => clearTimeout(initialCheckTimeout);\r\n  }, [status, session, checkForUnreadLetters]);\r\n\r\n  // Периодическая проверка\r\n  useEffect(() => {\r\n    if (status !== 'authenticated') {\r\n      if (intervalRef.current) {\r\n        clearInterval(intervalRef.current);\r\n        intervalRef.current = null;\r\n      }\r\n      return;\r\n    }\r\n\r\n    // @ts-expect-error - role может быть undefined\r\n    const userRole = session?.user?.role;\r\n    if (userRole !== 'CHIEF_DOCTOR') return;\r\n\r\n    // Запускаем периодическую проверку\r\n    intervalRef.current = setInterval(\r\n      checkForUnreadLetters,\r\n      NOTIFICATION_CHECK_INTERVAL\r\n    );\r\n\r\n    return () => {\r\n      if (intervalRef.current) {\r\n        clearInterval(intervalRef.current);\r\n        intervalRef.current = null;\r\n      }\r\n    };\r\n  }, [status, session, checkForUnreadLetters]);\r\n\r\n  // Очистка уведомления при прочтении письма\r\n  const clearNotifiedLetter = useCallback((letterId: number) => {\r\n    const notifiedLetters = JSON.parse(\r\n      localStorage.getItem(NOTIFIED_LETTERS_KEY) || '[]'\r\n    ) as number[];\r\n    const updated = notifiedLetters.filter((id) => id !== letterId && id !== letterId + 10000);\r\n    localStorage.setItem(NOTIFIED_LETTERS_KEY, JSON.stringify(updated));\r\n  }, []);\r\n\r\n  return {\r\n    checkForUnreadLetters,\r\n    clearNotifiedLetter,\r\n  };\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 185, "column": 0}, "map": {"version":3,"sources":["file:///C:/Study/commercial-projects/smartmedical/src/components/ChiefDoctorNotifications/ChiefDoctorNotifications.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useChiefDoctorNotifications } from '@/hooks/useChiefDoctorNotifications';\r\n\r\n// Компонент для инициализации уведомлений главного врача\r\n// Сам по себе ничего не рендерит, только активирует хук\r\nexport function ChiefDoctorNotifications() {\r\n  useChiefDoctorNotifications();\r\n  return null;\r\n}\r\n"],"names":[],"mappings":";;;;AAEA;;AAFA;;AAMO,SAAS;;IACd,IAAA,6KAA2B;IAC3B,OAAO;AACT;GAHgB;;QACd,6KAA2B;;;KADb","debugId":null}},
    {"offset": {"line": 213, "column": 0}, "map": {"version":3,"sources":["file:///C:/Study/commercial-projects/smartmedical/src/app/admin/layout.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { SessionProvider } from 'next-auth/react';\r\nimport { AlertProvider } from '@/components/common/SMAlert/AlertProvider';\r\nimport { ChiefDoctorNotifications } from '@/components/ChiefDoctorNotifications/ChiefDoctorNotifications';\r\n\r\nexport default function AdminLayout({\r\n  children,\r\n}: {\r\n  children: React.ReactNode;\r\n}) {\r\n  return (\r\n    <SessionProvider>\r\n      <AlertProvider>\r\n        <div className=\"min-h-screen bg-gray-50\">\r\n          {children}\r\n          <ChiefDoctorNotifications />\r\n        </div>\r\n      </AlertProvider>\r\n    </SessionProvider>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AAJA;;;;;AAMe,SAAS,YAAY,EAClC,QAAQ,EAGT;IACC,qBACE,6LAAC,oKAAe;kBACd,cAAA,6LAAC,4KAAa;sBACZ,cAAA,6LAAC;gBAAI,WAAU;;oBACZ;kCACD,6LAAC,yMAAwB;;;;;;;;;;;;;;;;;;;;;AAKnC;KAfwB","debugId":null}}]
}