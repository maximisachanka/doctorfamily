{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Study/commercial-projects/smartmedical/src/hooks/useUnreadCounts.ts"],"sourcesContent":["import { useState, useEffect } from 'react';\r\n\r\ninterface UnreadCounts {\r\n  feedbacks: number;\r\n  letters: number;\r\n  chats: number;\r\n}\r\n\r\nexport function useUnreadCounts(refreshInterval = 30000) {\r\n  const [counts, setCounts] = useState<UnreadCounts>({ feedbacks: 0, letters: 0, chats: 0 });\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  const fetchCounts = async () => {\r\n    try {\r\n      const res = await fetch('/api/admin/unread-counts');\r\n      if (res.ok) {\r\n        const data = await res.json();\r\n        setCounts(data);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching unread counts:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchCounts();\r\n\r\n    // Периодически обновляем счетчики\r\n    const interval = setInterval(fetchCounts, refreshInterval);\r\n\r\n    return () => clearInterval(interval);\r\n  }, [refreshInterval]);\r\n\r\n  return { counts, loading, refetch: fetchCounts };\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;;AAQO,SAAS,gBAAgB,kBAAkB,KAAK;;IACrD,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,yKAAQ,EAAe;QAAE,WAAW;QAAG,SAAS;QAAG,OAAO;IAAE;IACxF,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,yKAAQ,EAAC;IAEvC,MAAM,cAAc;QAClB,IAAI;YACF,MAAM,MAAM,MAAM,MAAM;YACxB,IAAI,IAAI,EAAE,EAAE;gBACV,MAAM,OAAO,MAAM,IAAI,IAAI;gBAC3B,UAAU;YACZ;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,iCAAiC;QACjD,SAAU;YACR,WAAW;QACb;IACF;IAEA,IAAA,0KAAS;qCAAC;YACR;YAEA,kCAAkC;YAClC,MAAM,WAAW,YAAY,aAAa;YAE1C;6CAAO,IAAM,cAAc;;QAC7B;oCAAG;QAAC;KAAgB;IAEpB,OAAO;QAAE;QAAQ;QAAS,SAAS;IAAY;AACjD;GA5BgB","debugId":null}},
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Study/commercial-projects/smartmedical/src/contexts/UnreadCountsContext.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { createContext, useContext, ReactNode } from 'react';\r\nimport { useUnreadCounts } from '@/hooks/useUnreadCounts';\r\n\r\ninterface UnreadCountsContextType {\r\n  counts: { feedbacks: number; letters: number; chats: number };\r\n  loading: boolean;\r\n  refetch: () => Promise<void>;\r\n}\r\n\r\nconst UnreadCountsContext = createContext<UnreadCountsContextType | undefined>(undefined);\r\n\r\nexport function UnreadCountsProvider({ children }: { children: ReactNode }) {\r\n  const { counts, loading, refetch } = useUnreadCounts(30000);\r\n\r\n  return (\r\n    <UnreadCountsContext.Provider value={{ counts, loading, refetch }}>\r\n      {children}\r\n    </UnreadCountsContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useUnreadCountsContext() {\r\n  const context = useContext(UnreadCountsContext);\r\n  if (!context) {\r\n    // Возвращаем дефолтные значения если контекст не доступен\r\n    return {\r\n      counts: { feedbacks: 0, letters: 0, chats: 0 },\r\n      loading: false,\r\n      refetch: async () => {},\r\n    };\r\n  }\r\n  return context;\r\n}\r\n"],"names":[],"mappings":";;;;;;;AAEA;AACA;;;AAHA;;;AAWA,MAAM,oCAAsB,IAAA,8KAAa,EAAsC;AAExE,SAAS,qBAAqB,EAAE,QAAQ,EAA2B;;IACxE,MAAM,EAAE,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,GAAG,IAAA,qJAAe,EAAC;IAErD,qBACE,6LAAC,oBAAoB,QAAQ;QAAC,OAAO;YAAE;YAAQ;YAAS;QAAQ;kBAC7D;;;;;;AAGP;GARgB;;QACuB,qJAAe;;;KADtC;AAUT,SAAS;;IACd,MAAM,UAAU,IAAA,2KAAU,EAAC;IAC3B,IAAI,CAAC,SAAS;QACZ,0DAA0D;QAC1D,OAAO;YACL,QAAQ;gBAAE,WAAW;gBAAG,SAAS;gBAAG,OAAO;YAAE;YAC7C,SAAS;YACT,SAAS,WAAa;QACxB;IACF;IACA,OAAO;AACT;IAXgB","debugId":null}},
    {"offset": {"line": 122, "column": 0}, "map": {"version":3,"sources":["file:///C:/Study/commercial-projects/smartmedical/src/hooks/useOperatorChatNotifications.ts"],"sourcesContent":["'use client';\r\n\r\nimport { useEffect, useRef, useCallback } from 'react';\r\nimport { useSession } from 'next-auth/react';\r\nimport { usePathname } from 'next/navigation';\r\nimport { useAlert } from '@/components/common/SMAlert/AlertProvider';\r\n\r\nconst NOTIFICATION_CHECK_INTERVAL = 15000; // 15 seconds (more frequent for chat)\r\nconst NOTIFIED_CHATS_KEY = 'chat-notifications-notified';\r\n\r\ninterface UnreadChat {\r\n  id: number;\r\n  patient: {\r\n    name: string;\r\n  };\r\n  messages: {\r\n    content: string;\r\n  }[];\r\n}\r\n\r\nexport function useOperatorChatNotifications() {\r\n  const { data: session, status } = useSession();\r\n  const pathname = usePathname();\r\n  const alert = useAlert();\r\n  const intervalRef = useRef<NodeJS.Timeout | null>(null);\r\n  const audioRef = useRef<HTMLAudioElement | null>(null);\r\n  const isAdminRef = useRef(false);\r\n\r\n  // Track if user is in admin panel\r\n  useEffect(() => {\r\n    isAdminRef.current = pathname?.startsWith('/admin') || false;\r\n  }, [pathname]);\r\n\r\n  // Initialize audio element\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined') {\r\n      audioRef.current = new Audio('/sounds/notification.mp3');\r\n      audioRef.current.volume = 0.5;\r\n    }\r\n  }, []);\r\n\r\n  const playNotificationSound = useCallback(() => {\r\n    if (audioRef.current) {\r\n      audioRef.current.currentTime = 0;\r\n      audioRef.current.play().catch(() => {\r\n        // Audio play failed - browser may block autoplay\r\n      });\r\n    }\r\n  }, []);\r\n\r\n  const checkForUnreadChats = useCallback(async () => {\r\n    // Only check if authenticated and in admin panel\r\n    if (status !== 'authenticated' || !session || !isAdminRef.current) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const response = await fetch('/api/operator-chat?unread_only=true');\r\n      if (!response.ok) return;\r\n\r\n      const data = await response.json();\r\n      const unreadChats: UnreadChat[] = data.chats || [];\r\n\r\n      if (unreadChats.length === 0) return;\r\n\r\n      // Get previously notified chats\r\n      const notifiedChats = JSON.parse(\r\n        localStorage.getItem(NOTIFIED_CHATS_KEY) || '[]'\r\n      ) as number[];\r\n\r\n      // Find new unread chats (not yet notified)\r\n      const newChats = unreadChats.filter(\r\n        (chat) => !notifiedChats.includes(chat.id)\r\n      );\r\n\r\n      if (newChats.length > 0) {\r\n        // Play notification sound\r\n        playNotificationSound();\r\n\r\n        // Show alert for new chats\r\n        if (newChats.length === 1) {\r\n          const chat = newChats[0];\r\n          const lastMessage = chat.messages[0]?.content || '';\r\n          const preview = lastMessage.length > 50\r\n            ? lastMessage.substring(0, 50) + '...'\r\n            : lastMessage;\r\n\r\n          alert.info(\r\n            `Новое сообщение от ${chat.patient.name}: \"${preview}\"`,\r\n            'Новое сообщение в чате'\r\n          );\r\n        } else {\r\n          alert.info(\r\n            `У вас ${newChats.length} новых сообщений в чате. Проверьте раздел \"Чат\".`,\r\n            'Новые сообщения'\r\n          );\r\n        }\r\n\r\n        // Mark these chats as notified\r\n        const updatedNotified = [\r\n          ...notifiedChats,\r\n          ...newChats.map((c) => c.id),\r\n        ];\r\n        localStorage.setItem(\r\n          NOTIFIED_CHATS_KEY,\r\n          JSON.stringify(updatedNotified)\r\n        );\r\n      }\r\n    } catch (error) {\r\n      console.error('Error checking for chat notifications:', error);\r\n    }\r\n  }, [session, status, alert, playNotificationSound]);\r\n\r\n  // Check on first login when in admin panel\r\n  useEffect(() => {\r\n    if (status !== 'authenticated' || !isAdminRef.current) return;\r\n\r\n    // Small delay to let the page load first\r\n    const initialCheckTimeout = setTimeout(() => {\r\n      checkForUnreadChats();\r\n    }, 2000);\r\n\r\n    return () => clearTimeout(initialCheckTimeout);\r\n  }, [status, pathname, checkForUnreadChats]);\r\n\r\n  // Set up periodic checking (only when in admin panel)\r\n  useEffect(() => {\r\n    if (status !== 'authenticated' || !isAdminRef.current) {\r\n      if (intervalRef.current) {\r\n        clearInterval(intervalRef.current);\r\n        intervalRef.current = null;\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Start periodic checks\r\n    intervalRef.current = setInterval(\r\n      checkForUnreadChats,\r\n      NOTIFICATION_CHECK_INTERVAL\r\n    );\r\n\r\n    return () => {\r\n      if (intervalRef.current) {\r\n        clearInterval(intervalRef.current);\r\n        intervalRef.current = null;\r\n      }\r\n    };\r\n  }, [status, pathname, checkForUnreadChats]);\r\n\r\n  return {\r\n    checkForUnreadChats,\r\n  };\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 287, "column": 0}, "map": {"version":3,"sources":["file:///C:/Study/commercial-projects/smartmedical/src/app/admin/AdminProviders.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { SessionProvider } from 'next-auth/react';\r\nimport { AlertProvider } from '@/components/common/SMAlert/AlertProvider';\r\nimport { UnreadCountsProvider } from '@/contexts/UnreadCountsContext';\r\nimport { useOperatorChatNotifications } from '@/hooks/useOperatorChatNotifications';\r\n\r\nfunction AdminNotifications({ children }: { children: React.ReactNode }) {\r\n  // Initialize operator chat notifications\r\n  useOperatorChatNotifications();\r\n\r\n  return <>{children}</>;\r\n}\r\n\r\nexport function AdminProviders({\r\n  children,\r\n}: {\r\n  children: React.ReactNode;\r\n}) {\r\n  return (\r\n    <SessionProvider>\r\n      <AlertProvider>\r\n        <UnreadCountsProvider>\r\n          <AdminNotifications>\r\n            <div className=\"min-h-screen bg-gray-50\">\r\n              {children}\r\n            </div>\r\n          </AdminNotifications>\r\n        </UnreadCountsProvider>\r\n      </AlertProvider>\r\n    </SessionProvider>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AACA;;;AALA;;;;;AAOA,SAAS,mBAAmB,EAAE,QAAQ,EAAiC;;IACrE,yCAAyC;IACzC,IAAA,+KAA4B;IAE5B,qBAAO;kBAAG;;AACZ;GALS;;QAEP,+KAA4B;;;KAFrB;AAOF,SAAS,eAAe,EAC7B,QAAQ,EAGT;IACC,qBACE,6LAAC,oKAAe;kBACd,cAAA,6LAAC,4KAAa;sBACZ,cAAA,6LAAC,kKAAoB;0BACnB,cAAA,6LAAC;8BACC,cAAA,6LAAC;wBAAI,WAAU;kCACZ;;;;;;;;;;;;;;;;;;;;;;;;;;AAOf;MAlBgB","debugId":null}}]
}