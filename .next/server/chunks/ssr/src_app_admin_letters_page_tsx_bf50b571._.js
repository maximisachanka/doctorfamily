module.exports=[14849,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(75003),e=a.i(62036),f=a.i(46271),g=a.i(92258),h=a.i(96221),i=a.i(41675),j=a.i(16201),k=a.i(41710),l=a.i(92759),m=a.i(77156),n=a.i(33508),o=a.i(56468),p=a.i(46864),q=a.i(67974),r=a.i(72663),s=a.i(4297),t=a.i(52913),u=a.i(55220),v=a.i(79212),w=a.i(96215),x=a.i(37210),y=a.i(72549);a.i(27190);var z=a.i(25170),A=a.i(60514);function B(){let{status:a}=(0,d.useSession)(),{sessionVerified:B,isLoading:C,verifySession:D}=(0,v.useAdminSession)(),[E,F]=(0,c.useState)(null),[G,H]=(0,c.useState)(!1),I=(0,y.useConfirmDialog)(),{success:J,error:K}=(0,z.useAlert)(),{refetch:L}=(0,A.useUnreadCountsContext)(),[M,N]=(0,c.useState)([]),[O,P]=(0,c.useState)(!1),[Q,R]=(0,c.useState)(""),[S,T]=(0,c.useState)(1),[U,V]=(0,c.useState)("unread"),[W,X]=(0,c.useState)(null),[Y,Z]=(0,c.useState)(""),[$,_]=(0,c.useState)(!1),[aa,ab]=(0,c.useState)(!1);(0,c.useEffect)(()=>{"authenticated"===a?ac():"unauthenticated"===a&&F(!1)},[a]),(0,c.useEffect)(()=>{B&&E&&G&&ad()},[B,E,G]);let ac=async()=>{try{let a=await fetch("/api/admin/auth"),b=await a.json();F(b.isAdmin),H(b.isChiefDoctor)}catch(a){F(!1)}},ad=async()=>{P(!0);try{let a=await fetch("/api/admin/letters");if(a.ok){let b=await a.json();N(b),await fetch("/api/admin/letters/mark-all-read",{method:"POST"}),await L()}}catch(a){console.error("Error loading data:",a)}finally{P(!1)}},ae=(0,c.useMemo)(()=>{let a=M;if("unread"===U?a=a.filter(a=>!a.reply||a.has_new_patient_message):"replied"===U&&(a=a.filter(a=>a.reply&&!a.has_new_patient_message)),Q){let b=Q.toLowerCase();a=a.filter(a=>a.subject.toLowerCase().includes(b)||a.content.toLowerCase().includes(b)||a.patient.name.toLowerCase().includes(b)||a.patient.email.toLowerCase().includes(b))}return a},[M,Q,U]),af=(0,c.useMemo)(()=>M.filter(a=>!a.reply||a.has_new_patient_message).length,[M]);(0,c.useEffect)(()=>{T(1)},[Q,U]);let ag=Math.ceil(ae.length/12),ah=(0,c.useMemo)(()=>{let a=(S-1)*12;return ae.slice(a,a+12)},[ae,S]),ai=async a=>{if(X(a),Z(a.reply||""),!a.is_read)try{await fetch(`/api/admin/letters/${a.id}`),N(b=>b.map(b=>b.id===a.id?{...b,is_read:!0}:b))}catch(a){console.error("Error marking letter as read:",a)}},aj=async()=>{if(W&&Y.trim()){_(!0);try{let a=await fetch(`/api/admin/letters/${W.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({reply:Y})});if(a.ok)await ad(),X(null),Z(""),J("Ответ отправлен");else{let b=await a.json();K(b.error||"Ошибка отправки")}}catch(a){K("Ошибка отправки")}finally{_(!1)}}},ak=async(a,b)=>{if(await I.confirm({title:"Удаление письма",message:`Вы уверены, что хотите удалить письмо "${b}"? Это действие нельзя отменить.`,confirmText:"Удалить",cancelText:"Отмена",variant:"danger"}))try{let b=await fetch(`/api/admin/letters/${a}`,{method:"DELETE"});if(b.ok)await ad(),J("Письмо удалено");else{let a=await b.json();K(a.error||"Ошибка удаления")}}catch(a){K("Ошибка удаления")}},al=async(a,b)=>{if(await I.confirm({title:b?"Разблокировка пользователя":"Блокировка пользователя",message:`Вы уверены, что хотите ${b?"разблокировать":"заблокировать"} этого пользователя? ${!b?"Он не сможет отправлять письма.":""}`,confirmText:b?"Разблокировать":"Заблокировать",cancelText:"Отмена",variant:b?"warning":"danger"})){ab(!0);try{let c=await fetch(`/api/admin/users/${a}/block`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({blocked:!b})});if(c.ok)N(c=>c.map(c=>c.patient.id===a?{...c,patient:{...c.patient,is_messages_blocked:!b}}:c)),W&&W.patient.id===a&&X(a=>a?{...a,patient:{...a.patient,is_messages_blocked:!b}}:null),J(b?"Пользователь разблокирован":"Пользователь заблокирован");else{let a=await c.json();K(a.error||"Ошибка")}}catch(a){K("Ошибка при изменении статуса")}finally{ab(!1)}}},am=a=>{let b=a.trim().split(/\s+/);return b.length>=2?(b[0][0]+b[1][0]).toUpperCase():a.slice(0,2).toUpperCase()};return"loading"===a||null===E||C?(0,b.jsx)(w.AdminAccessSkeleton,{}):"unauthenticated"!==a&&E&&G?B?(0,b.jsxs)("div",{className:"flex min-h-screen bg-gray-50",children:[(0,b.jsx)(r.AdminMenu,{}),(0,b.jsx)("div",{className:"flex-1 p-4 lg:p-8 overflow-auto",children:(0,b.jsxs)("div",{className:"max-w-7xl mx-auto",children:[(0,b.jsxs)(s.AdminSection,{title:"Письма главному врачу",icon:g.Mail,count:M.length,loading:O,searchValue:Q,onSearchChange:R,children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-6",children:[(0,b.jsxs)("button",{onClick:()=>V("unread"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${"unread"===U?"bg-amber-500 text-white shadow-md":"bg-white text-gray-600 hover:bg-gray-100 border border-gray-200"}`,children:[(0,b.jsx)(k.Clock,{className:"w-4 h-4"}),"Без ответа",af>0&&(0,b.jsx)("span",{className:`px-2 py-0.5 rounded-full text-xs font-bold ${"unread"===U?"bg-white/20 text-white":"bg-amber-100 text-amber-700"}`,children:af})]}),(0,b.jsxs)("button",{onClick:()=>V("replied"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${"replied"===U?"bg-[#18A36C] text-white shadow-md":"bg-white text-gray-600 hover:bg-gray-100 border border-gray-200"}`,children:[(0,b.jsx)(j.CheckCircle,{className:"w-4 h-4"}),"С ответом"]}),(0,b.jsxs)("button",{onClick:()=>V("all"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${"all"===U?"bg-gray-700 text-white shadow-md":"bg-white text-gray-600 hover:bg-gray-100 border border-gray-200"}`,children:[(0,b.jsx)(g.Mail,{className:"w-4 h-4"}),"Все письма"]})]}),0===ae.length?(0,b.jsx)(s.EmptyState,{icon:g.Mail,title:"Письма не найдены",description:Q?"Попробуйте изменить поисковый запрос":"Пока нет писем от пациентов"}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:(0,b.jsx)(e.AnimatePresence,{children:ah.map(a=>(0,b.jsxs)(s.ItemCard,{children:[(0,b.jsxs)("div",{className:"flex gap-4",children:[(0,b.jsx)("div",{className:"w-12 h-12 rounded-full overflow-hidden flex-shrink-0 bg-[#18A36C] flex items-center justify-center",children:a.patient.avatar_url?(0,b.jsx)("img",{src:a.patient.avatar_url,alt:a.patient.name,className:"w-full h-full object-cover"}):(0,b.jsx)("span",{className:"text-sm font-semibold text-white",children:am(a.patient.name)})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,b.jsx)("h3",{className:"font-semibold text-gray-800 truncate",children:a.subject}),!a.is_read&&!a.reply&&(0,b.jsx)("span",{className:"w-2 h-2 bg-amber-500 rounded-full flex-shrink-0"})]}),(0,b.jsx)("p",{className:"text-sm text-gray-500 mb-1",children:a.patient.name}),(0,b.jsxs)("p",{className:"text-xs text-gray-400 flex items-center gap-1",children:[(0,b.jsx)(i.Calendar,{className:"w-3 h-3"}),new Date(a.created_at).toLocaleDateString("ru-RU",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})]})]})]}),(0,b.jsx)("p",{className:"text-sm text-gray-500 line-clamp-2 mt-3",children:a.content}),(0,b.jsxs)("div",{className:"flex items-center gap-2 mt-3 flex-wrap",children:[a.patient.is_messages_blocked&&(0,b.jsxs)(s.Badge,{variant:"danger",children:[(0,b.jsx)(o.Ban,{className:"w-3 h-3 mr-1"}),"Заблокирован"]}),a.has_new_patient_message?(0,b.jsx)(s.Badge,{variant:"warning",children:"Новое сообщение"}):a.reply?(0,b.jsx)(s.Badge,{variant:"success",children:"Отвечено"}):(0,b.jsx)(s.Badge,{variant:"warning",children:"Ожидает ответа"}),a.messages&&a.messages.length>0&&(0,b.jsxs)(s.Badge,{variant:"secondary",children:[a.messages.length+1," сообщ."]})]}),(0,b.jsxs)("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-gray-100",children:[(0,b.jsxs)("button",{onClick:()=>ai(a),className:"flex items-center gap-1.5 px-3 py-1.5 bg-[#18A36C] text-white text-sm font-medium rounded-lg hover:bg-[#15905f] transition-colors",children:[(0,b.jsx)(m.Eye,{className:"w-4 h-4"}),a.reply?"Просмотреть":"Ответить"]}),(0,b.jsx)("button",{onClick:()=>ak(a.id,a.subject),className:"p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors",title:"Удалить",children:(0,b.jsx)(n.X,{className:"w-4 h-4"})})]})]},a.id))})}),ag>1&&(0,b.jsx)(q.Pagination,{currentPage:S,totalPages:ag,onPageChange:T,className:"mt-6"})]})]}),(0,b.jsx)(e.AnimatePresence,{children:W&&(0,b.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[(0,b.jsx)(f.motion.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>!$&&X(null),className:"absolute inset-0 bg-black/50 backdrop-blur-sm"}),(0,b.jsxs)(f.motion.div,{initial:{opacity:0,scale:.95,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:20},className:"relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col",children:[(0,b.jsx)("div",{className:"bg-[#18A36C] px-6 py-4 flex-shrink-0",children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsx)("h2",{className:"text-xl font-semibold text-white",children:"Письмо"}),(0,b.jsx)("button",{onClick:()=>!$&&X(null),className:"p-1.5 hover:bg-white/20 rounded-lg transition-colors",children:(0,b.jsx)(n.X,{className:"w-5 h-5 text-white"})})]})}),(0,b.jsxs)("div",{className:"p-6 overflow-y-auto flex-1",children:[(0,b.jsxs)("div",{className:"flex items-start gap-4 mb-4 pb-4 border-b border-gray-100",children:[(0,b.jsx)("div",{className:"w-14 h-14 rounded-full overflow-hidden flex-shrink-0 bg-[#18A36C] flex items-center justify-center",children:W.patient.avatar_url?(0,b.jsx)("img",{src:W.patient.avatar_url,alt:W.patient.name,className:"w-full h-full object-cover"}):(0,b.jsx)("span",{className:"text-lg font-semibold text-white",children:am(W.patient.name)})}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("h3",{className:"font-semibold text-gray-800 text-lg",children:W.patient.name}),W.patient.is_messages_blocked&&(0,b.jsxs)("span",{className:"px-2 py-0.5 bg-red-100 text-red-600 text-xs font-medium rounded-full flex items-center gap-1",children:[(0,b.jsx)(o.Ban,{className:"w-3 h-3"}),"Заблокирован"]})]}),(0,b.jsx)("p",{className:"text-sm text-gray-500",children:W.patient.email}),(0,b.jsx)("p",{className:"text-sm text-gray-500",children:W.patient.phone})]}),(0,b.jsxs)("button",{onClick:()=>al(W.patient.id,W.patient.is_messages_blocked),disabled:aa,className:`flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 ${W.patient.is_messages_blocked?"bg-green-100 text-green-700 hover:bg-green-200":"bg-red-100 text-red-700 hover:bg-red-200"}`,title:W.patient.is_messages_blocked?"Разблокировать пользователя":"Заблокировать пользователя",children:[aa?(0,b.jsx)(h.Loader2,{className:"w-4 h-4 animate-spin"}):W.patient.is_messages_blocked?(0,b.jsx)(p.UserCheck,{className:"w-4 h-4"}):(0,b.jsx)(o.Ban,{className:"w-4 h-4"}),W.patient.is_messages_blocked?"Разблокировать":"Заблокировать"]})]}),(0,b.jsx)("h4",{className:"font-semibold text-gray-800 text-lg mb-2",children:W.subject}),(0,b.jsx)("p",{className:"text-xs text-gray-400 mb-4",children:new Date(W.created_at).toLocaleDateString("ru-RU",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}),(0,b.jsxs)("div",{className:"space-y-4 mb-6",children:[(0,b.jsxs)("div",{className:"flex gap-3",children:[(0,b.jsx)("div",{className:"w-8 h-8 rounded-full overflow-hidden flex-shrink-0 bg-[#18A36C] flex items-center justify-center",children:W.patient.avatar_url?(0,b.jsx)("img",{src:W.patient.avatar_url,alt:W.patient.name,className:"w-full h-full object-cover"}):(0,b.jsx)("span",{className:"text-xs font-semibold text-white",children:am(W.patient.name)})}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("div",{className:"bg-gray-100 rounded-xl p-4",children:(0,b.jsx)("p",{className:"text-gray-700 whitespace-pre-wrap",children:W.content})}),(0,b.jsx)("p",{className:"text-xs text-gray-400 mt-1",children:new Date(W.created_at).toLocaleDateString("ru-RU",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})})]})]}),W.reply&&(0,b.jsx)("div",{className:"flex gap-3 justify-end",children:(0,b.jsxs)("div",{className:"flex-1 max-w-[85%]",children:[(0,b.jsx)("div",{className:"bg-[#18A36C]/10 rounded-xl p-4",children:(0,b.jsx)("p",{className:"text-gray-700 whitespace-pre-wrap",children:W.reply})}),(0,b.jsxs)("p",{className:"text-xs text-gray-400 mt-1 text-right",children:[(0,b.jsx)(j.CheckCircle,{className:"w-3 h-3 inline mr-1 text-[#18A36C]"}),"Вы, ",W.replied_at&&new Date(W.replied_at).toLocaleDateString("ru-RU",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})]})]})}),W.messages&&W.messages.map(a=>(0,b.jsxs)("div",{className:`flex gap-3 ${"chief_doctor"===a.sender_type?"justify-end":""}`,children:["patient"===a.sender_type&&(0,b.jsx)("div",{className:"w-8 h-8 rounded-full overflow-hidden flex-shrink-0 bg-[#18A36C] flex items-center justify-center",children:W.patient.avatar_url?(0,b.jsx)("img",{src:W.patient.avatar_url,alt:W.patient.name,className:"w-full h-full object-cover"}):(0,b.jsx)("span",{className:"text-xs font-semibold text-white",children:am(W.patient.name)})}),(0,b.jsxs)("div",{className:`flex-1 ${"chief_doctor"===a.sender_type?"max-w-[85%]":""}`,children:[(0,b.jsx)("div",{className:`rounded-xl p-4 ${"chief_doctor"===a.sender_type?"bg-[#18A36C]/10":"bg-gray-100"}`,children:(0,b.jsx)("p",{className:"text-gray-700 whitespace-pre-wrap",children:a.content})}),(0,b.jsxs)("p",{className:`text-xs text-gray-400 mt-1 ${"chief_doctor"===a.sender_type?"text-right":""}`,children:["chief_doctor"===a.sender_type&&(0,b.jsx)(j.CheckCircle,{className:"w-3 h-3 inline mr-1 text-[#18A36C]"}),"chief_doctor"===a.sender_type?"Вы":W.patient.name.split(" ")[0],", ",new Date(a.created_at).toLocaleDateString("ru-RU",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})]})]})]},a.id))]}),G&&(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:W.reply?"Продолжить переписку":"Ваш ответ"}),(0,b.jsx)("textarea",{value:Y,onChange:a=>Z(a.target.value),rows:4,className:"w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-[#18A36C]/20 focus:border-[#18A36C] transition-all resize-none",placeholder:"Введите ваш ответ пациенту..."})]}),!G&&(0,b.jsx)("div",{className:"bg-amber-50 border border-amber-200 rounded-xl p-4",children:(0,b.jsx)("p",{className:"text-amber-700 text-sm",children:"Только главный врач может отвечать на письма пациентов."})})]}),G&&(0,b.jsxs)("div",{className:"flex items-center gap-3 p-6 pt-0 flex-shrink-0",children:[(0,b.jsx)("button",{onClick:()=>X(null),disabled:$,className:"flex-1 px-4 py-2.5 border border-gray-200 text-gray-700 font-medium rounded-xl hover:bg-gray-50 transition-colors disabled:opacity-50",children:"Закрыть"}),(0,b.jsxs)("button",{onClick:aj,disabled:$||!Y.trim(),className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-[#18A36C] text-white font-medium rounded-xl hover:bg-[#15905f] transition-colors disabled:opacity-50",children:[$?(0,b.jsx)(h.Loader2,{className:"w-4 h-4 animate-spin"}):(0,b.jsx)(l.Send,{className:"w-4 h-4"}),"Отправить"]})]})]})]})}),(0,b.jsx)(x.ConfirmDialog,{isOpen:I.isOpen,onClose:I.handleCancel,onConfirm:I.handleConfirm,title:I.options.title,message:I.options.message,confirmText:I.options.confirmText,cancelText:I.options.cancelText,variant:I.options.variant,loading:I.loading})]})})]}):(0,b.jsx)(u.AdminAuthForm,{onSuccess:()=>{D()}}):(0,b.jsx)(t.default,{})}a.s(["default",()=>B])}];

//# sourceMappingURL=src_app_admin_letters_page_tsx_bf50b571._.js.map