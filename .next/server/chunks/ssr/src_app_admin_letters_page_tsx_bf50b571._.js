module.exports=[14849,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(75003),e=a.i(62036),f=a.i(46271),g=a.i(92258),h=a.i(96221),i=a.i(41675),j=a.i(16201),k=a.i(41710),l=a.i(92759),m=a.i(77156),n=a.i(33508),o=a.i(56468),p=a.i(46864),q=a.i(67974),r=a.i(72663),s=a.i(4297),t=a.i(52913),u=a.i(55220),v=a.i(79212),w=a.i(96215),x=a.i(37210),y=a.i(72549);a.i(27190);var z=a.i(25170),A=a.i(3038),B=a.i(60514);function C(){let{status:a}=(0,d.useSession)(),{sessionVerified:C,isLoading:D,verifySession:E}=(0,v.useAdminSession)(),[F,G]=(0,c.useState)(null),[H,I]=(0,c.useState)(!1),J=(0,y.useConfirmDialog)(),{success:K,error:L}=(0,z.useAlert)(),{refetch:M}=(0,B.useUnreadCountsContext)(),{currentPage:N,setPage:O,buildApiUrl:P}=(0,A.useServerPagination)(12),[Q,R]=(0,c.useState)([]),[S,T]=(0,c.useState)(1),[U,V]=(0,c.useState)(0),[W,X]=(0,c.useState)(0),[Y,Z]=(0,c.useState)(0),[$,_]=(0,c.useState)(!1),[aa,ab]=(0,c.useState)(""),[ac,ad]=(0,c.useState)("unread"),[ae,af]=(0,c.useState)(null),[ag,ah]=(0,c.useState)(""),[ai,aj]=(0,c.useState)(!1),[ak,al]=(0,c.useState)(!1);(0,c.useEffect)(()=>{"authenticated"===a?am():"unauthenticated"===a&&G(!1)},[a]);let am=async()=>{try{let a=await fetch("/api/admin/auth"),b=await a.json();G(b.isAdmin),I(b.isChiefDoctor)}catch(a){G(!1)}},an=async()=>{try{let[a,b]=await Promise.all([fetch("/api/admin/letters?page=1&limit=1&status=unread"),fetch("/api/admin/letters?page=1&limit=1&status=replied")]);if(a.ok){let b=await a.json();X(b.totalCount||0)}if(b.ok){let a=await b.json();Z(a.totalCount||0)}}catch(a){console.error("Error loading counts:",a)}},ao=async()=>{_(!0);try{let a=P("/api/admin/letters",aa)+`&status=${ac}`,[b]=await Promise.all([fetch(a),an()]);if(b.ok){let a=await b.json();R(a.data||[]),T(a.totalPages||1),V(a.totalCount||0),await fetch("/api/admin/letters/mark-all-read",{method:"POST"}),await M()}}catch(a){console.error("Error loading data:",a),L("Ошибка загрузки данных")}finally{_(!1)}};(0,c.useEffect)(()=>{C&&F&&H&&ao()},[C,F,H,N,aa,ac]),(0,c.useEffect)(()=>{O(1)},[aa,ac]);let ap=async a=>{if(af(a),ah(a.reply||""),!a.is_read)try{await fetch(`/api/admin/letters/${a.id}`),R(b=>b.map(b=>b.id===a.id?{...b,is_read:!0}:b))}catch(a){console.error("Error marking letter as read:",a)}},aq=async()=>{if(ae&&ag.trim()){aj(!0);try{let a=await fetch(`/api/admin/letters/${ae.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({reply:ag})});if(a.ok)await ao(),af(null),ah(""),K("Ответ отправлен");else{let b=await a.json();L(b.error||"Ошибка отправки")}}catch(a){L("Ошибка отправки")}finally{aj(!1)}}},ar=async(a,b)=>{if(await J.confirm({title:"Удаление письма",message:`Вы уверены, что хотите удалить письмо "${b}"? Это действие нельзя отменить.`,confirmText:"Удалить",cancelText:"Отмена",variant:"danger"}))try{let b=await fetch(`/api/admin/letters/${a}`,{method:"DELETE"});if(b.ok)await ao(),K("Письмо удалено");else{let a=await b.json();L(a.error||"Ошибка удаления")}}catch(a){L("Ошибка удаления")}},as=async(a,b)=>{if(await J.confirm({title:b?"Разблокировка пользователя":"Блокировка пользователя",message:`Вы уверены, что хотите ${b?"разблокировать":"заблокировать"} этого пользователя? ${!b?"Он не сможет отправлять письма.":""}`,confirmText:b?"Разблокировать":"Заблокировать",cancelText:"Отмена",variant:b?"warning":"danger"})){al(!0);try{let c=await fetch(`/api/admin/users/${a}/block`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({blocked:!b})});if(c.ok)R(c=>c.map(c=>c.patient.id===a?{...c,patient:{...c.patient,is_messages_blocked:!b}}:c)),ae&&ae.patient.id===a&&af(a=>a?{...a,patient:{...a.patient,is_messages_blocked:!b}}:null),K(b?"Пользователь разблокирован":"Пользователь заблокирован");else{let a=await c.json();L(a.error||"Ошибка")}}catch(a){L("Ошибка при изменении статуса")}finally{al(!1)}}},at=a=>{let b=a.trim().split(/\s+/);return b.length>=2?(b[0][0]+b[1][0]).toUpperCase():a.slice(0,2).toUpperCase()};return"loading"===a||null===F||D?(0,b.jsx)(w.AdminAccessSkeleton,{}):"unauthenticated"!==a&&F&&H?C?(0,b.jsxs)("div",{className:"flex min-h-screen bg-gray-50",children:[(0,b.jsx)(r.AdminMenu,{}),(0,b.jsx)("div",{className:"flex-1 p-4 lg:p-8 overflow-auto",children:(0,b.jsxs)("div",{className:"max-w-7xl mx-auto",children:[(0,b.jsxs)(s.AdminSection,{title:"Письма главному врачу",icon:g.Mail,count:U,loading:$,searchValue:aa,onSearchChange:ab,children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-6",children:[(0,b.jsxs)("button",{onClick:()=>ad("unread"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${"unread"===ac?"bg-amber-500 text-white shadow-md":"bg-white text-gray-600 hover:bg-gray-100 border border-gray-200"}`,children:[(0,b.jsx)(k.Clock,{className:"w-4 h-4"}),"Без ответа",W>0&&(0,b.jsx)("span",{className:`px-2 py-0.5 rounded-full text-xs font-bold ${"unread"===ac?"bg-white/20 text-white":"bg-amber-100 text-amber-700"}`,children:W})]}),(0,b.jsxs)("button",{onClick:()=>ad("replied"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${"replied"===ac?"bg-[#18A36C] text-white shadow-md":"bg-white text-gray-600 hover:bg-gray-100 border border-gray-200"}`,children:[(0,b.jsx)(j.CheckCircle,{className:"w-4 h-4"}),"С ответом"]}),(0,b.jsxs)("button",{onClick:()=>ad("all"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${"all"===ac?"bg-gray-700 text-white shadow-md":"bg-white text-gray-600 hover:bg-gray-100 border border-gray-200"}`,children:[(0,b.jsx)(g.Mail,{className:"w-4 h-4"}),"Все письма"]})]}),0===Q.length?(0,b.jsx)(s.EmptyState,{icon:g.Mail,title:"Письма не найдены",description:aa?"Попробуйте изменить поисковый запрос":"Пока нет писем от пациентов"}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:(0,b.jsx)(e.AnimatePresence,{children:Q.map(a=>(0,b.jsxs)(s.ItemCard,{children:[(0,b.jsxs)("div",{className:"flex gap-4",children:[(0,b.jsx)("div",{className:"w-12 h-12 rounded-full overflow-hidden flex-shrink-0 bg-[#18A36C] flex items-center justify-center",children:a.patient.avatar_url?(0,b.jsx)("img",{src:a.patient.avatar_url,alt:a.patient.name,className:"w-full h-full object-cover"}):(0,b.jsx)("span",{className:"text-sm font-semibold text-white",children:at(a.patient.name)})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,b.jsx)("h3",{className:"font-semibold text-gray-800 truncate",children:a.subject}),!a.is_read&&!a.reply&&(0,b.jsx)("span",{className:"w-2 h-2 bg-amber-500 rounded-full flex-shrink-0"})]}),(0,b.jsx)("p",{className:"text-sm text-gray-500 mb-1",children:a.patient.name}),(0,b.jsxs)("p",{className:"text-xs text-gray-400 flex items-center gap-1",children:[(0,b.jsx)(i.Calendar,{className:"w-3 h-3"}),new Date(a.created_at).toLocaleDateString("ru-RU",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})]})]})]}),(0,b.jsx)("p",{className:"text-sm text-gray-500 line-clamp-2 mt-3",children:a.content}),(0,b.jsxs)("div",{className:"flex items-center gap-2 mt-3 flex-wrap",children:[a.patient.is_messages_blocked&&(0,b.jsxs)(s.Badge,{variant:"danger",children:[(0,b.jsx)(o.Ban,{className:"w-3 h-3 mr-1"}),"Заблокирован"]}),a.has_new_patient_message?(0,b.jsx)(s.Badge,{variant:"warning",children:"Новое сообщение"}):a.reply?(0,b.jsx)(s.Badge,{variant:"success",children:"Отвечено"}):(0,b.jsx)(s.Badge,{variant:"warning",children:"Ожидает ответа"}),a.messages&&a.messages.length>0&&(0,b.jsxs)(s.Badge,{variant:"secondary",children:[a.messages.length+1," сообщ."]})]}),(0,b.jsxs)("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-gray-100",children:[(0,b.jsxs)("button",{onClick:()=>ap(a),className:"flex items-center gap-1.5 px-3 py-1.5 bg-[#18A36C] text-white text-sm font-medium rounded-lg hover:bg-[#15905f] transition-colors",children:[(0,b.jsx)(m.Eye,{className:"w-4 h-4"}),a.reply?"Просмотреть":"Ответить"]}),(0,b.jsx)("button",{onClick:()=>ar(a.id,a.subject),className:"p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors",title:"Удалить",children:(0,b.jsx)(n.X,{className:"w-4 h-4"})})]})]},a.id))})}),S>1&&(0,b.jsx)(q.Pagination,{currentPage:N,totalPages:S,onPageChange:O,className:"mt-6"})]})]}),(0,b.jsx)(e.AnimatePresence,{children:ae&&(0,b.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[(0,b.jsx)(f.motion.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>!ai&&af(null),className:"absolute inset-0 bg-black/50 backdrop-blur-sm"}),(0,b.jsxs)(f.motion.div,{initial:{opacity:0,scale:.95,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:20},className:"relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col",children:[(0,b.jsx)("div",{className:"bg-[#18A36C] px-6 py-4 flex-shrink-0",children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsx)("h2",{className:"text-xl font-semibold text-white",children:"Письмо"}),(0,b.jsx)("button",{onClick:()=>!ai&&af(null),className:"p-1.5 hover:bg-white/20 rounded-lg transition-colors",children:(0,b.jsx)(n.X,{className:"w-5 h-5 text-white"})})]})}),(0,b.jsxs)("div",{className:"p-6 overflow-y-auto flex-1",children:[(0,b.jsxs)("div",{className:"flex items-start gap-4 mb-4 pb-4 border-b border-gray-100",children:[(0,b.jsx)("div",{className:"w-14 h-14 rounded-full overflow-hidden flex-shrink-0 bg-[#18A36C] flex items-center justify-center",children:ae.patient.avatar_url?(0,b.jsx)("img",{src:ae.patient.avatar_url,alt:ae.patient.name,className:"w-full h-full object-cover"}):(0,b.jsx)("span",{className:"text-lg font-semibold text-white",children:at(ae.patient.name)})}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("h3",{className:"font-semibold text-gray-800 text-lg",children:ae.patient.name}),ae.patient.is_messages_blocked&&(0,b.jsxs)("span",{className:"px-2 py-0.5 bg-red-100 text-red-600 text-xs font-medium rounded-full flex items-center gap-1",children:[(0,b.jsx)(o.Ban,{className:"w-3 h-3"}),"Заблокирован"]})]}),(0,b.jsx)("p",{className:"text-sm text-gray-500",children:ae.patient.email}),(0,b.jsx)("p",{className:"text-sm text-gray-500",children:ae.patient.phone})]}),(0,b.jsxs)("button",{onClick:()=>as(ae.patient.id,ae.patient.is_messages_blocked),disabled:ak,className:`flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 ${ae.patient.is_messages_blocked?"bg-green-100 text-green-700 hover:bg-green-200":"bg-red-100 text-red-700 hover:bg-red-200"}`,title:ae.patient.is_messages_blocked?"Разблокировать пользователя":"Заблокировать пользователя",children:[ak?(0,b.jsx)(h.Loader2,{className:"w-4 h-4 animate-spin"}):ae.patient.is_messages_blocked?(0,b.jsx)(p.UserCheck,{className:"w-4 h-4"}):(0,b.jsx)(o.Ban,{className:"w-4 h-4"}),ae.patient.is_messages_blocked?"Разблокировать":"Заблокировать"]})]}),(0,b.jsx)("h4",{className:"font-semibold text-gray-800 text-lg mb-2",children:ae.subject}),(0,b.jsx)("p",{className:"text-xs text-gray-400 mb-4",children:new Date(ae.created_at).toLocaleDateString("ru-RU",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}),(0,b.jsxs)("div",{className:"space-y-4 mb-6",children:[(0,b.jsxs)("div",{className:"flex gap-3",children:[(0,b.jsx)("div",{className:"w-8 h-8 rounded-full overflow-hidden flex-shrink-0 bg-[#18A36C] flex items-center justify-center",children:ae.patient.avatar_url?(0,b.jsx)("img",{src:ae.patient.avatar_url,alt:ae.patient.name,className:"w-full h-full object-cover"}):(0,b.jsx)("span",{className:"text-xs font-semibold text-white",children:at(ae.patient.name)})}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("div",{className:"bg-gray-100 rounded-xl p-4",children:(0,b.jsx)("p",{className:"text-gray-700 whitespace-pre-wrap",children:ae.content})}),(0,b.jsx)("p",{className:"text-xs text-gray-400 mt-1",children:new Date(ae.created_at).toLocaleDateString("ru-RU",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})})]})]}),ae.reply&&(0,b.jsx)("div",{className:"flex gap-3 justify-end",children:(0,b.jsxs)("div",{className:"flex-1 max-w-[85%]",children:[(0,b.jsx)("div",{className:"bg-[#18A36C]/10 rounded-xl p-4",children:(0,b.jsx)("p",{className:"text-gray-700 whitespace-pre-wrap",children:ae.reply})}),(0,b.jsxs)("p",{className:"text-xs text-gray-400 mt-1 text-right",children:[(0,b.jsx)(j.CheckCircle,{className:"w-3 h-3 inline mr-1 text-[#18A36C]"}),"Вы, ",ae.replied_at&&new Date(ae.replied_at).toLocaleDateString("ru-RU",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})]})]})}),ae.messages&&ae.messages.map(a=>(0,b.jsxs)("div",{className:`flex gap-3 ${"chief_doctor"===a.sender_type?"justify-end":""}`,children:["patient"===a.sender_type&&(0,b.jsx)("div",{className:"w-8 h-8 rounded-full overflow-hidden flex-shrink-0 bg-[#18A36C] flex items-center justify-center",children:ae.patient.avatar_url?(0,b.jsx)("img",{src:ae.patient.avatar_url,alt:ae.patient.name,className:"w-full h-full object-cover"}):(0,b.jsx)("span",{className:"text-xs font-semibold text-white",children:at(ae.patient.name)})}),(0,b.jsxs)("div",{className:`flex-1 ${"chief_doctor"===a.sender_type?"max-w-[85%]":""}`,children:[(0,b.jsx)("div",{className:`rounded-xl p-4 ${"chief_doctor"===a.sender_type?"bg-[#18A36C]/10":"bg-gray-100"}`,children:(0,b.jsx)("p",{className:"text-gray-700 whitespace-pre-wrap",children:a.content})}),(0,b.jsxs)("p",{className:`text-xs text-gray-400 mt-1 ${"chief_doctor"===a.sender_type?"text-right":""}`,children:["chief_doctor"===a.sender_type&&(0,b.jsx)(j.CheckCircle,{className:"w-3 h-3 inline mr-1 text-[#18A36C]"}),"chief_doctor"===a.sender_type?"Вы":ae.patient.name.split(" ")[0],", ",new Date(a.created_at).toLocaleDateString("ru-RU",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})]})]})]},a.id))]}),H&&(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:ae.reply?"Продолжить переписку":"Ваш ответ"}),(0,b.jsx)("textarea",{value:ag,onChange:a=>ah(a.target.value),rows:4,className:"w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-[#18A36C]/20 focus:border-[#18A36C] transition-all resize-none",placeholder:"Введите ваш ответ пациенту..."})]}),!H&&(0,b.jsx)("div",{className:"bg-amber-50 border border-amber-200 rounded-xl p-4",children:(0,b.jsx)("p",{className:"text-amber-700 text-sm",children:"Только главный врач может отвечать на письма пациентов."})})]}),H&&(0,b.jsxs)("div",{className:"flex items-center gap-3 p-6 pt-0 flex-shrink-0",children:[(0,b.jsx)("button",{onClick:()=>af(null),disabled:ai,className:"flex-1 px-4 py-2.5 border border-gray-200 text-gray-700 font-medium rounded-xl hover:bg-gray-50 transition-colors disabled:opacity-50",children:"Закрыть"}),(0,b.jsxs)("button",{onClick:aq,disabled:ai||!ag.trim(),className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-[#18A36C] text-white font-medium rounded-xl hover:bg-[#15905f] transition-colors disabled:opacity-50",children:[ai?(0,b.jsx)(h.Loader2,{className:"w-4 h-4 animate-spin"}):(0,b.jsx)(l.Send,{className:"w-4 h-4"}),"Отправить"]})]})]})]})}),(0,b.jsx)(x.ConfirmDialog,{isOpen:J.isOpen,onClose:J.handleCancel,onConfirm:J.handleConfirm,title:J.options.title,message:J.options.message,confirmText:J.options.confirmText,cancelText:J.options.cancelText,variant:J.options.variant,loading:J.loading})]})})]}):(0,b.jsx)(u.AdminAuthForm,{onSuccess:()=>{E()}}):(0,b.jsx)(t.default,{})}a.s(["default",()=>C])}];

//# sourceMappingURL=src_app_admin_letters_page_tsx_bf50b571._.js.map