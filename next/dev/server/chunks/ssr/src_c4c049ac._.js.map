{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Study/commercial-projects/smartmedical/src/hooks/useUnreadCounts.ts"],"sourcesContent":["import { useState, useEffect } from 'react';\n\ninterface UnreadCounts {\n  feedbacks: number;\n  letters: number;\n  chats: number;\n}\n\nexport function useUnreadCounts(refreshInterval = 30000) {\n  const [counts, setCounts] = useState<UnreadCounts>({ feedbacks: 0, letters: 0, chats: 0 });\n  const [loading, setLoading] = useState(true);\n\n  const fetchCounts = async () => {\n    try {\n      const res = await fetch('/api/admin/unread-counts');\n      if (res.ok) {\n        const data = await res.json();\n        setCounts(data);\n      }\n    } catch (error) {\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchCounts();\n\n    // Периодически обновляем счетчики\n    const interval = setInterval(fetchCounts, refreshInterval);\n\n    return () => clearInterval(interval);\n  }, [refreshInterval]);\n\n  return { counts, loading, refetch: fetchCounts };\n}\n"],"names":[],"mappings":";;;;AAAA;;AAQO,SAAS,gBAAgB,kBAAkB,KAAK;IACrD,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,iNAAQ,EAAe;QAAE,WAAW;QAAG,SAAS;QAAG,OAAO;IAAE;IACxF,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,iNAAQ,EAAC;IAEvC,MAAM,cAAc;QAClB,IAAI;YACF,MAAM,MAAM,MAAM,MAAM;YACxB,IAAI,IAAI,EAAE,EAAE;gBACV,MAAM,OAAO,MAAM,IAAI,IAAI;gBAC3B,UAAU;YACZ;QACF,EAAE,OAAO,OAAO,CAChB,SAAU;YACR,WAAW;QACb;IACF;IAEA,IAAA,kNAAS,EAAC;QACR;QAEA,kCAAkC;QAClC,MAAM,WAAW,YAAY,aAAa;QAE1C,OAAO,IAAM,cAAc;IAC7B,GAAG;QAAC;KAAgB;IAEpB,OAAO;QAAE;QAAQ;QAAS,SAAS;IAAY;AACjD","debugId":null}},
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Study/commercial-projects/smartmedical/src/contexts/UnreadCountsContext.tsx"],"sourcesContent":["'use client';\n\nimport { createContext, useContext, ReactNode } from 'react';\nimport { useUnreadCounts } from '@/hooks/useUnreadCounts';\n\ninterface UnreadCountsContextType {\n  counts: { feedbacks: number; letters: number; chats: number };\n  loading: boolean;\n  refetch: () => Promise<void>;\n}\n\nconst UnreadCountsContext = createContext<UnreadCountsContextType | undefined>(undefined);\n\nexport function UnreadCountsProvider({ children }: { children: ReactNode }) {\n  const { counts, loading, refetch } = useUnreadCounts(30000);\n\n  return (\n    <UnreadCountsContext.Provider value={{ counts, loading, refetch }}>\n      {children}\n    </UnreadCountsContext.Provider>\n  );\n}\n\nexport function useUnreadCountsContext() {\n  const context = useContext(UnreadCountsContext);\n  if (!context) {\n    // Возвращаем дефолтные значения если контекст не доступен\n    return {\n      counts: { feedbacks: 0, letters: 0, chats: 0 },\n      loading: false,\n      refetch: async () => {},\n    };\n  }\n  return context;\n}\n"],"names":[],"mappings":";;;;;;;AAEA;AACA;AAHA;;;;AAWA,MAAM,oCAAsB,IAAA,sNAAa,EAAsC;AAExE,SAAS,qBAAqB,EAAE,QAAQ,EAA2B;IACxE,MAAM,EAAE,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,GAAG,IAAA,kJAAe,EAAC;IAErD,qBACE,8OAAC,oBAAoB,QAAQ;QAAC,OAAO;YAAE;YAAQ;YAAS;QAAQ;kBAC7D;;;;;;AAGP;AAEO,SAAS;IACd,MAAM,UAAU,IAAA,mNAAU,EAAC;IAC3B,IAAI,CAAC,SAAS;QACZ,0DAA0D;QAC1D,OAAO;YACL,QAAQ;gBAAE,WAAW;gBAAG,SAAS;gBAAG,OAAO;YAAE;YAC7C,SAAS;YACT,SAAS,WAAa;QACxB;IACF;IACA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 95, "column": 0}, "map": {"version":3,"sources":["file:///C:/Study/commercial-projects/smartmedical/src/hooks/useOperatorChatNotifications.ts"],"sourcesContent":["'use client';\n\nimport { useEffect, useRef, useCallback } from 'react';\nimport { useSession } from 'next-auth/react';\nimport { usePathname } from 'next/navigation';\nimport { useAlert } from '@/components/common/SMAlert/AlertProvider';\n\nconst NOTIFICATION_CHECK_INTERVAL = 15000; // 15 seconds (more frequent for chat)\nconst NOTIFIED_CHATS_KEY = 'chat-notifications-notified';\n\ninterface UnreadChat {\n  id: number;\n  patient: {\n    name: string;\n  };\n  messages: {\n    content: string;\n  }[];\n}\n\nexport function useOperatorChatNotifications() {\n  const { data: session, status } = useSession();\n  const pathname = usePathname();\n  const alert = useAlert();\n  const intervalRef = useRef<NodeJS.Timeout | null>(null);\n  const audioRef = useRef<HTMLAudioElement | null>(null);\n  const isAdminRef = useRef(false);\n\n  // Track if user is in admin panel\n  useEffect(() => {\n    isAdminRef.current = pathname?.startsWith('/admin') || false;\n  }, [pathname]);\n\n  // Initialize audio element\n  useEffect(() => {\n    if (typeof window !== 'undefined') {\n      audioRef.current = new Audio('/sounds/notification.mp3');\n      audioRef.current.volume = 0.5;\n    }\n  }, []);\n\n  const playNotificationSound = useCallback(() => {\n    if (audioRef.current) {\n      audioRef.current.currentTime = 0;\n      audioRef.current.play().catch(() => {\n        // Audio play failed - browser may block autoplay\n      });\n    }\n  }, []);\n\n  const checkForUnreadChats = useCallback(async () => {\n    // Only check if authenticated and in admin panel\n    if (status !== 'authenticated' || !session || !isAdminRef.current) {\n      return;\n    }\n\n    try {\n      const response = await fetch('/api/operator-chat?unread_only=true');\n      if (!response.ok) return;\n\n      const data = await response.json();\n      const unreadChats: UnreadChat[] = data.chats || [];\n\n      if (unreadChats.length === 0) return;\n\n      // Get previously notified chats\n      const notifiedChats = JSON.parse(\n        localStorage.getItem(NOTIFIED_CHATS_KEY) || '[]'\n      ) as number[];\n\n      // Find new unread chats (not yet notified)\n      const newChats = unreadChats.filter(\n        (chat) => !notifiedChats.includes(chat.id)\n      );\n\n      if (newChats.length > 0) {\n        // Play notification sound\n        playNotificationSound();\n\n        // Show alert for new chats\n        if (newChats.length === 1) {\n          const chat = newChats[0];\n          const lastMessage = chat.messages[0]?.content || '';\n          const preview = lastMessage.length > 50\n            ? lastMessage.substring(0, 50) + '...'\n            : lastMessage;\n\n          alert.info(\n            `Новое сообщение от ${chat.patient.name}: \"${preview}\"`,\n            'Новое сообщение в чате'\n          );\n        } else {\n          alert.info(\n            `У вас ${newChats.length} новых сообщений в чате. Проверьте раздел \"Чат\".`,\n            'Новые сообщения'\n          );\n        }\n\n        // Mark these chats as notified\n        const updatedNotified = [\n          ...notifiedChats,\n          ...newChats.map((c) => c.id),\n        ];\n        localStorage.setItem(\n          NOTIFIED_CHATS_KEY,\n          JSON.stringify(updatedNotified)\n        );\n      }\n    } catch (error) {\n    }\n  }, [session, status, alert, playNotificationSound]);\n\n  // Check on first login when in admin panel\n  useEffect(() => {\n    if (status !== 'authenticated' || !isAdminRef.current) return;\n\n    // Small delay to let the page load first\n    const initialCheckTimeout = setTimeout(() => {\n      checkForUnreadChats();\n    }, 2000);\n\n    return () => clearTimeout(initialCheckTimeout);\n  }, [status, pathname, checkForUnreadChats]);\n\n  // Set up periodic checking (only when in admin panel)\n  useEffect(() => {\n    if (status !== 'authenticated' || !isAdminRef.current) {\n      if (intervalRef.current) {\n        clearInterval(intervalRef.current);\n        intervalRef.current = null;\n      }\n      return;\n    }\n\n    // Start periodic checks\n    intervalRef.current = setInterval(\n      checkForUnreadChats,\n      NOTIFICATION_CHECK_INTERVAL\n    );\n\n    return () => {\n      if (intervalRef.current) {\n        clearInterval(intervalRef.current);\n        intervalRef.current = null;\n      }\n    };\n  }, [status, pathname, checkForUnreadChats]);\n\n  return {\n    checkForUnreadChats,\n  };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 220, "column": 0}, "map": {"version":3,"sources":["file:///C:/Study/commercial-projects/smartmedical/src/app/admin/AdminProviders.tsx"],"sourcesContent":["'use client';\n\nimport { SessionProvider } from 'next-auth/react';\nimport { AlertProvider } from '@/components/common/SMAlert/AlertProvider';\nimport { UnreadCountsProvider } from '@/contexts/UnreadCountsContext';\nimport { useOperatorChatNotifications } from '@/hooks/useOperatorChatNotifications';\n\nfunction AdminNotifications({ children }: { children: React.ReactNode }) {\n  // Initialize operator chat notifications\n  useOperatorChatNotifications();\n\n  return <>{children}</>;\n}\n\nexport function AdminProviders({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  return (\n    <SessionProvider>\n      <AlertProvider>\n        <UnreadCountsProvider>\n          <AdminNotifications>\n            <div className=\"min-h-screen bg-gray-50\">\n              {children}\n            </div>\n          </AdminNotifications>\n        </UnreadCountsProvider>\n      </AlertProvider>\n    </SessionProvider>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AACA;AALA;;;;;;AAOA,SAAS,mBAAmB,EAAE,QAAQ,EAAiC;IACrE,yCAAyC;IACzC,IAAA,4KAA4B;IAE5B,qBAAO;kBAAG;;AACZ;AAEO,SAAS,eAAe,EAC7B,QAAQ,EAGT;IACC,qBACE,8OAAC,iKAAe;kBACd,cAAA,8OAAC,yKAAa;sBACZ,cAAA,8OAAC,+JAAoB;0BACnB,cAAA,8OAAC;8BACC,cAAA,8OAAC;wBAAI,WAAU;kCACZ;;;;;;;;;;;;;;;;;;;;;;;;;;AAOf","debugId":null}}]
}