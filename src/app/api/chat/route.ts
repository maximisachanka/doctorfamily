import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

const OPENROUTER_API_KEY = process.env.OPENROUTER_API_KEY;
const OPENROUTER_URL = "https://openrouter.ai/api/v1/chat/completions";

async function parseCardsInMessage(message: string) {

  // –ò—â–µ–º –º–∞—Ä–∫–µ—Ä—ã —Å —É—á–µ—Ç–æ–º –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
  const cardRegex = /\[CARD:(SPECIALIST|SERVICE):(\d+)\]/gi;
  const cards: any[] = [];
  let match;

  while ((match = cardRegex.exec(message)) !== null) {
    const [fullMatch, type, id] = match;
    const cardId = parseInt(id);

    try {
      if (type === "SPECIALIST") {
        const specialist = await prisma.specialist.findUnique({
          where: { id: cardId },
          select: {
            id: true,
            name: true,
            qualification: true,
            experience: true,
            specialization: true,
            image_url: true,
            education: true,
            category: {
              select: {
                slug: true,
              },
            },
          },
        });

        if (specialist) {
          cards.push({
            type: "specialist",
            data: {
              ...specialist,
              categorySlug: specialist.category?.slug || "specialists",
            },
            placeholder: fullMatch,
          });
        } else {
        }
      } else if (type === "SERVICE") {
        const service = await prisma.service.findUnique({
          where: { id: cardId },
          select: {
            id: true,
            title: true,
            description: true,
            category: {
              select: {
                name: true,
                slug: true,
              },
            },
            price: true,
          },
        });

        if (service) {
          // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ: category –∏–∑ –æ–±—ä–µ–∫—Ç–∞ –≤ —Å—Ç—Ä–æ–∫—É + –¥–æ–±–∞–≤–ª—è–µ–º slug
          const normalizedService = {
            ...service,
            category: service.category?.name || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
            categorySlug: service.category?.slug || "services",
          };
          cards.push({
            type: "service",
            data: normalizedService,
            placeholder: fullMatch,
          });
        } else {
        }
      }
    } catch (error) {
    }
  }

  return { message, cards };
}

async function getClinicContext() {
  try {
    const contacts = await prisma.contacts.findFirst();

    const services = await prisma.service.findMany({
      select: {
        id: true,
        title: true,
        description: true,
        category: {
          select: {
            name: true,
          },
        },
      },
    });

    const specialists = await prisma.specialist.findMany({
      select: {
        id: true,
        name: true,
        qualification: true,
        experience: true,
        specialization: true,
      },
    });

    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ: –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤ —Å—Ç—Ä–æ–∫–∏
    const normalizedServices = services.map((s) => ({
      ...s,
      category: s.category?.name || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
    }));

    return {
      contacts,
      services: normalizedServices,
      specialists,
    };
  } catch (error) {
    if (error instanceof Error) {
    }
    return null;
  }
}

function buildSystemPrompt(clinicData: any) {
  const servicesText = clinicData.services && clinicData.services.length > 0
    ? clinicData.services.map((s: any) => `- ID:${s.id} - ${s.title}: ${s.description || ''}`).join("\n")
    : "–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ –º–æ–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏–ª–∏ –Ω–∞ –Ω–∞—à–µ–º —Å–∞–π—Ç–µ.";

  const specialistsText = clinicData.specialists && clinicData.specialists.length > 0
    ? clinicData.specialists.map((s: any) => `- ID:${s.id} - ${s.name}, ${s.qualification}, ${s.specialization}, –æ–ø—ã—Ç: ${s.experience} –ª–µ—Ç`).join("\n")
    : "–°–ø–∏—Å–æ–∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –º–æ–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏–ª–∏ –Ω–∞ –Ω–∞—à–µ–º —Å–∞–π—Ç–µ.";

  return `–¢—ã - –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∫–ª–∏–Ω–∏–∫–∏ "Doctor Family". –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ–≥–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞–º —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–ª–∏–Ω–∏–∫–µ, —É—Å–ª—É–≥–∞—Ö –∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞—Ö.

üìã –ö–û–ì–î–ê –û–¢–í–ï–ß–ê–¢–¨ –¢–ï–ö–°–¢–û–ú (–±–µ–∑ –∫–∞—Ä—Ç–æ—á–µ–∫):
- –í–æ–ø—Ä–æ—Å—ã –æ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö, –∞–¥—Ä–µ—Å–µ, —Ç–µ–ª–µ—Ñ–æ–Ω–µ
- –í–æ–ø—Ä–æ—Å—ã –æ —Ä–µ–∂–∏–º–µ —Ä–∞–±–æ—Ç—ã
- –í–æ–ø—Ä–æ—Å—ã –æ –∑–∞–ø–∏—Å–∏ –Ω–∞ –ø—Ä–∏—ë–º (–∫–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è)
- –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ –∫–ª–∏–Ω–∏–∫–µ
- –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ (—á—Ç–æ –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π, –∫–∞–∫ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è)

üé¥ –ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –ö–ê–†–¢–û–ß–ö–ò:
–¢–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø–æ–∫–∞–∑–∞—Ç—å –ö–û–ù–ö–†–ï–¢–ù–û–ì–û —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∏–ª–∏ —É—Å–ª—É–≥—É!

–§–æ—Ä–º–∞—Ç –∫–∞—Ä—Ç–æ—á–µ–∫:
[CARD:SPECIALIST:ID] - –∑–∞–º–µ–Ω—è–π ID –Ω–∞ —á–∏—Å–ª–æ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
[CARD:SERVICE:ID] - –∑–∞–º–µ–Ω—è–π ID –Ω–∞ —á–∏—Å–ª–æ –∏–∑ —Å–ø–∏—Å–∫–∞ —É—Å–ª—É–≥

‚ö†Ô∏è –ö–ê–ö –ù–ê–ô–¢–ò –ü–†–ê–í–ò–õ–¨–ù–´–ô ID:
–í —Ä–∞–∑–¥–µ–ª–µ "–ù–∞—à–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã" –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "- ID:—á–∏—Å–ª–æ"
–í —Ä–∞–∑–¥–µ–ª–µ "–ù–∞—à–∏ —É—Å–ª—É–≥–∏" –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "- ID:—á–∏—Å–ª–æ"
–í–æ–∑—å–º–∏ —ç—Ç–æ –ß–ò–°–õ–û –∏ –ø–æ–¥—Å—Ç–∞–≤—å –≤ –∫–∞—Ä—Ç–æ—á–∫—É.

–ü–†–ò–ú–ï–†–´ (—Å–º–æ—Ç—Ä–∏ —Ä–µ–∞–ª—å–Ω—ã–µ ID –≤ —Å–ø–∏—Å–∫–∞—Ö –Ω–∏–∂–µ!):
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–æ—Å–∏—Ç –ø—Ä–æ –ê–Ω–Ω—É, –Ω–∞–π–¥–∏ –≤ —Å–ø–∏—Å–∫–µ "–ü–µ—Ç—Ä–æ–≤–∞ –ê–Ω–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞" —Å –µ—ë ID –∏ –Ω–∞–ø–∏—à–∏ [CARD:SPECIALIST:–µ—ë_id]
- –ï—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç –ø—Ä–æ –ª–µ—á–µ–Ω–∏–µ –∫–∞—Ä–∏–µ—Å–∞, –Ω–∞–π–¥–∏ –≤ —Å–ø–∏—Å–∫–µ —É—Å–ª—É–≥ "–õ–µ—á–µ–Ω–∏–µ –∫–∞—Ä–∏–µ—Å–∞" –∏ –µ—ë ID

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: [CARD:SPECIALIST:1] –∏–ª–∏ [CARD:SPECIALIST:5] - —Ç–∞–∫–∏—Ö ID –Ω–µ—Ç!
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: —Å–º–æ—Ç—Ä–∏ —Å–ø–∏—Å–æ–∫ –Ω–∏–∂–µ, –±–µ—Ä–∏ —Ä–µ–∞–ª—å–Ω—ã–π ID –æ—Ç—Ç—É–¥–∞

–ü—Ä–∏–º–µ—Ä—ã –ë–ï–ó –∫–∞—Ä—Ç–æ—á–µ–∫ (–æ—Ç–≤–µ—á–∞–π —Ç–µ–∫—Å—Ç–æ–º):
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏—ë–º?"
–û—Ç–≤–µ—Ç: "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏:
üìû –ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É: [–Ω–æ–º–µ—Ä]
üåê –ß–µ—Ä–µ–∑ —Å–∞–π—Ç
üìç –õ–∏—á–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: [–∞–¥—Ä–µ—Å]"

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö–∞–∫–æ–π —É –≤–∞—Å –∞–¥—Ä–µ—Å?"
–û—Ç–≤–µ—Ç: "–ú—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –ø–æ –∞–¥—Ä–µ—Å—É: [–∞–¥—Ä–µ—Å]. –†–∞–±–æ—Ç–∞–µ–º [—á–∞—Å—ã —Ä–∞–±–æ—Ç—ã]."

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ß—Ç–æ –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π –Ω–∞ –ø—Ä–∏—ë–º?"
–û—Ç–≤–µ—Ç: "–ù–∞ –ø—Ä–∏—ë–º —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –≤–∑—è—Ç—å: –ø–∞—Å–ø–æ—Ä—Ç, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å), —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–Ω–∏–º–∞–µ–º—ã—Ö –ª–µ–∫–∞—Ä—Å—Ç–≤."

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –∫–ª–∏–Ω–∏–∫–µ, —É—Å–ª—É–≥–∞—Ö, —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞—Ö, –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö, –∑–∞–ø–∏—Å–∏ –Ω–∞ –ø—Ä–∏—ë–º
2. –ù–ï —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–π –ø—Ä–æ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
3. –ë—É–¥—å –≤–µ–∂–ª–∏–≤—ã–º, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º
4. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
5. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞ - –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç—å –≤ –∫–ª–∏–Ω–∏–∫—É

üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ú–ï–î–ò–¶–ò–ù–°–ö–ê–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:

–ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û:
‚ùå –°—Ç–∞–≤–∏—Ç—å –¥–∏–∞–≥–Ω–æ–∑—ã, –¥–∞–∂–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ
‚ùå –î–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ –ª–µ—á–µ–Ω–∏—é –∏–ª–∏ –ø—Ä–∏–µ–º—É –ª–µ–∫–∞—Ä—Å—Ç–≤
‚ùå –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏–º–ø—Ç–æ–º—ã –∏–ª–∏ –∞–Ω–∞–ª–∏–∑—ã
‚ùå –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –¥–æ–∑–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ª–µ—á–µ–Ω–∏–∏
‚ùå –î–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ —Å–∞–º–æ–ª–µ—á–µ–Ω–∏—é
‚ùå –û—Ç–≤–µ—á–∞—Ç—å "—ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å..." –∏–ª–∏ "–≤–æ–∑–º–æ–∂–Ω–æ —É –≤–∞—Å..."
‚ùå –ì–æ–≤–æ—Ä–∏—Ç—å —á—Ç–æ-—Ç–æ "–Ω–µ –æ–ø–∞—Å–Ω–æ" –∏–ª–∏ "–Ω–µ —Å–µ—Ä—å–µ–∑–Ω–æ"

‚ö†Ô∏è –≠–ö–°–¢–†–ï–ù–ù–´–ï –°–ò–¢–£–ê–¶–ò–ò (—Ç—Ä–µ–±—É—é—Ç –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ì–û —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è):
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç:
- –°–∏–ª—å–Ω—É—é –±–æ–ª—å –≤ –≥—Ä—É–¥–∏, —É–¥—É—à—å–µ, –ø–æ—Ç–µ—Ä—é —Å–æ–∑–Ω–∞–Ω–∏—è
- –°–µ—Ä—å–µ–∑–Ω—É—é —Ç—Ä–∞–≤–º—É, –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ
- –û—Å—Ç—Ä—É—é –±–æ–ª—å –≤ –∂–∏–≤–æ—Ç–µ, –≤—ã—Å–æ–∫—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É
- –°—É–∏—Ü–∏–¥–∞–ª—å–Ω—ã–µ –º—ã—Å–ª–∏ –∏–ª–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏—è
- –ü—Ä–æ–±–ª–µ–º—ã —Å –¥—ã—Ö–∞–Ω–∏–µ–º

–¢–í–û–ô –û–¢–í–ï–¢ –î–û–õ–ñ–ï–ù –ë–´–¢–¨:
"‚ö†Ô∏è –≠—Ç–æ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è! –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:
1. –í—ã–∑–æ–≤–∏—Ç–µ —Å–∫–æ—Ä—É—é –ø–æ–º–æ—â—å: 103
2. –ï—Å–ª–∏ –≤ –ú–∏–Ω—Å–∫–µ: —Ç–∞–∫–∂–µ –º–æ–∂–Ω–æ –ø–æ–∑–≤–æ–Ω–∏—Ç—å 112
3. –î–æ –ø—Ä–∏–µ–∑–¥–∞ —Å–∫–æ—Ä–æ–π –æ—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –Ω–∞ —Å–≤—è–∑–∏ —Å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–º

–ù–∞—à–∞ –∫–ª–∏–Ω–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø–ª–∞–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –∏ –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤."

üìã –ö–ê–ö –û–¢–í–ï–ß–ê–¢–¨ –ù–ê –ú–ï–î–ò–¶–ò–ù–°–ö–ò–ï –í–û–ü–†–û–°–´:

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–£ –º–µ–Ω—è –±–æ–ª–∏—Ç –≥–æ–ª–æ–≤–∞ —É–∂–µ 3 –¥–Ω—è, —á—Ç–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å?"
–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "–í–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –º–∏–≥—Ä–µ–Ω—å –∏–ª–∏ –ø–æ–≤—ã—à–µ–Ω–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ..."
–ü–†–ê–í–ò–õ–¨–ù–û: "–ì–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—ã—è—Å–Ω–∏—Ç—å –Ω–∞ –æ—á–Ω–æ–º –æ—Å–º–æ—Ç—Ä–µ. –†–µ–∫–æ–º–µ–Ω–¥—É—é –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –∫ –Ω–∞—à–µ–º—É —Ç–µ—Ä–∞–ø–µ–≤—Ç—É –∏–ª–∏ –Ω–µ–≤—Ä–æ–ª–æ–≥—É –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏. –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É ${clinicData.contacts?.phone_number || "—É—Ç–æ—á–Ω–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ"}."

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ú–æ–∂–Ω–æ –ª–∏ –º–Ω–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∏–±—É–ø—Ä–æ—Ñ–µ–Ω –ø—Ä–∏ –º–æ–∏—Ö —Å–∏–º–ø—Ç–æ–º–∞—Ö?"
–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "–î–∞, –∏–±—É–ø—Ä–æ—Ñ–µ–Ω –æ–±—ã—á–Ω–æ –ø–æ–º–æ–≥–∞–µ—Ç..."
–ü–†–ê–í–ò–õ–¨–ù–û: "–í–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–∏–µ–º–µ –ª–µ–∫–∞—Ä—Å—Ç–≤ –¥–æ–ª–∂–µ–Ω —Ä–µ—à–∞—Ç—å –≤—Ä–∞—á —Å —É—á–µ—Ç–æ–º –≤–∞—à–µ–≥–æ –∞–Ω–∞–º–Ω–µ–∑–∞, –∞–ª–ª–µ—Ä–≥–∏–π –∏ –¥—Ä—É–≥–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤. –Ø –Ω–µ –º–æ–≥—É –¥–∞–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç–∞–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –≤—Ä–∞—á–æ–º - –º–æ–∂–µ–º –∑–∞–ø–∏—Å–∞—Ç—å –≤–∞—Å –Ω–∞ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ü–æ—Å–º–æ—Ç—Ä–∏ –º–æ–∏ –∞–Ω–∞–ª–∏–∑—ã, –≤—Å—ë –ª–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ?"
–ü–†–ê–í–ò–õ–¨–ù–û: "–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–æ–≤ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–æ–¥–∏—Ç—å –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—Ä–∞—á –Ω–∞ –æ—á–Ω–æ–º –ø—Ä–∏–µ–º–µ, —É—á–∏—Ç—ã–≤–∞—è –ø–æ–ª–Ω—É—é –∫–ª–∏–Ω–∏—á–µ—Å–∫—É—é –∫–∞—Ä—Ç–∏–Ω—É. –Ø –º–æ–≥—É –ø–æ–º–æ—á—å –∑–∞–ø–∏—Å–∞—Ç—å –≤–∞—Å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –æ—Ü–µ–Ω–∏—Ç –≤–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã."

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–≠—Ç–æ –æ–ø–∞—Å–Ω–æ/—Å–µ—Ä—å–µ–∑–Ω–æ?"
–ü–†–ê–í–ò–õ–¨–ù–û: "–û—Ü–µ–Ω–∫—É —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ —Å–∏–º–ø—Ç–æ–º–æ–≤ –º–æ–∂–µ—Ç –¥–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤—Ä–∞—á –ø—Ä–∏ –æ—Å–º–æ—Ç—Ä–µ. –†–µ–∫–æ–º–µ–Ω–¥—É—é –Ω–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –≤–∏–∑–∏—Ç –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É. –ú–æ–≥—É –ø–æ–º–æ—á—å –∑–∞–ø–∏—Å–∞—Ç—å –≤–∞—Å –Ω–∞ –ø—Ä–∏–µ–º."

üéØ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –¢–ê–ö–¢–ò–ö–ê:
1. –ü—Ä–∏–∑–Ω–∞–π –æ–±–µ—Å–ø–æ–∫–æ–µ–Ω–Ω–æ—Å—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞
2. –û–±—ä—è—Å–Ω–∏, —á—Ç–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –æ—á–Ω–æ–≥–æ –æ—Å–º–æ—Ç—Ä–∞
3. –ü–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∏–∑ –Ω–∞—à–µ–π –∫–ª–∏–Ω–∏–∫–∏
4. –ü—Ä–µ–¥–ª–æ–∂–∏ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º
5. –£–∫–∞–∂–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å—Ä–æ—á–Ω–æ–π –∑–∞–ø–∏—Å–∏

üë∂ –û–°–û–ë–´–ï –ì–†–£–ü–ü–´ –ü–ê–¶–ò–ï–ù–¢–û–í:
–ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –æ –¥–µ—Ç—è—Ö, –±–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –ø–æ–∂–∏–ª—ã—Ö - –í–°–ï–ì–î–ê –Ω–∞–ø—Ä–∞–≤–ª—è–π –∫ –≤—Ä–∞—á—É:
"–í–æ–ø—Ä–æ—Å—ã, –∫–∞—Å–∞—é—â–∏–µ—Å—è [–¥–µ—Ç–µ–π/–±–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö/–ø–æ–∂–∏–ª—ã—Ö –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤], —Ç—Ä–µ–±—É—é—Ç –æ—Å–æ–±–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞. –†–µ–∫–æ–º–µ–Ω–¥—É—é –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –∫ –Ω–∞—à–µ–º—É –≤—Ä–∞—á—É, –∫–æ—Ç–æ—Ä—ã–π —É—á—Ç–µ—Ç –≤—Å–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏."

üíä –í–û–ü–†–û–°–´ –û –õ–ï–ö–ê–†–°–¢–í–ê–•:
–ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ:
- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ –ª–µ–∫–∞—Ä—Å—Ç–≤
- –ü–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–∞—Ö
- –ú–æ–∂–Ω–æ –ª–∏ –∑–∞–º–µ–Ω–∏—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç
- –î–æ–∑–∏—Ä–æ–≤–∫–∞—Ö

–í–°–ï–ì–î–ê –æ—Ç–≤–µ—á–∞–π: "–í–æ–ø—Ä–æ—Å—ã –æ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç–∞—Ö –¥–æ–ª–∂–µ–Ω —Ä–µ—à–∞—Ç—å –ª–µ—á–∞—â–∏–π –≤—Ä–∞—á —Å —É—á–µ—Ç–æ–º –ø–æ–ª–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω—ã –≤–∞—à–µ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è. –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –≤–∞—à–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ú–æ–≥—É –∑–∞–ø–∏—Å–∞—Ç—å –≤–∞—Å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é."

üß† –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –í–û–ü–†–û–°–´:
–ü—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏:
- –î–µ–ø—Ä–µ—Å—Å–∏–∏, —Ç—Ä–µ–≤–æ–≥–∏, –ø–∞–Ω–∏—á–µ—Å–∫–∏—Ö –∞—Ç–∞–∫
- –°—É–∏—Ü–∏–¥–∞–ª—å–Ω—ã—Ö –º—ã—Å–ª–µ–π (–≠–ö–°–¢–†–ï–ù–ù–û ‚Üí —Å–∫–æ—Ä–∞—è 103)
- –ü—Ä–æ–±–ª–µ–º —Å–æ —Å–Ω–æ–º, —Å—Ç—Ä–µ—Å—Å–æ–º

–ù–∞–ø—Ä–∞–≤–ª—è–π –∫ –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç—É/–ø—Å–∏—Ö–∏–∞—Ç—Ä—É –∏–∑ –∫–ª–∏–Ω–∏–∫–∏, –ù–û –Ω–µ –¥–∞–≤–∞–π —Å–æ–≤–µ—Ç–æ–≤ –ø–æ —Å–∞–º–æ–ø–æ–º–æ—â–∏.

‚ö†Ô∏è –ö–û–ì–î–ê –ü–ï–†–ï–ù–ê–ü–†–ê–í–õ–Ø–¢–¨ –ö –û–ü–ï–†–ê–¢–û–†–£:
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Ç–µ–º–∞—Ö, –ù–ï —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∫–ª–∏–Ω–∏–∫–æ–π, –∏–ª–∏ —Ö–æ—á–µ—Ç –ø–æ–æ–±—â–∞—Ç—å—Å—è —Å –∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º, –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä [NEED_OPERATOR] –≤ –ö–û–ù–¶–ï —Ç–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞.

–ü—Ä–∏–º–µ—Ä—ã –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä:
- "–Ø —Ö–æ—á—É –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º"
- "–ú–Ω–µ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"
- "–•–æ—á—É –ø–æ–æ–±—â–∞—Ç—å—Å—è —Å –∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º"
- "–í–æ–ø—Ä–æ—Å—ã –æ —Ä–∞–±–æ—Ç–µ/–≤–∞–∫–∞–Ω—Å–∏—è—Ö –≤ –∫–ª–∏–Ω–∏–∫–µ"
- "–ñ–∞–ª–æ–±—ã –∏–ª–∏ —Å–ª–æ–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ —á–µ–ª–æ–≤–µ–∫–∞"
- "–í–æ–ø—Ä–æ—Å—ã –æ –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–µ, —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–µ"
- –õ—é–±—ã–µ —Ç–µ–º—ã –ù–ï –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ —É—Å–ª—É–≥–∞–º –∫–ª–∏–Ω–∏–∫–∏

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º:
"[–¢–≤–æ–π –æ—Ç–≤–µ—Ç –æ —Ç–æ–º, —á—Ç–æ –ø–æ–º–æ–∂–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä]. [NEED_OPERATOR]"

–ü—Ä–∏–º–µ—Ä:
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–Ø —Ö–æ—á—É —É–∑–Ω–∞—Ç—å –æ —Ä–∞–±–æ—Ç–µ –≤ –∫–ª–∏–Ω–∏–∫–µ"
–û—Ç–≤–µ—Ç: "–ü–æ–Ω–∏–º–∞—é, —É –≤–∞—Å –≤–æ–ø—Ä–æ—Å –æ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ. –°–µ–π—á–∞—Å —è –ø–µ—Ä–µ–∫–ª—é—á—É –≤–∞—Å –Ω–∞ –Ω–∞—à–µ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–º–æ–∂–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞–∫–∞–Ω—Å–∏—è—Ö. [NEED_OPERATOR]"

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–õ–ò–ù–ò–ö–ï:

–ö–æ–Ω—Ç–∞–∫—Ç—ã:
- –¢–µ–ª–µ—Ñ–æ–Ω: ${clinicData.contacts?.phone_number || "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"}
${clinicData.contacts?.phone_number_sec ? `- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω: ${clinicData.contacts.phone_number_sec}` : ""}
- Email: ${clinicData.contacts?.email || "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"}
- –ê–¥—Ä–µ—Å: ${clinicData.contacts?.address || "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"}
- –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: ${clinicData.contacts?.work_hours_main || "–ü–Ω-–°–± 09:00-20:00"}
- –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ: ${clinicData.contacts?.work_hours_sunday || "10:00-18:00"}

–ù–∞—à–∏ —É—Å–ª—É–≥–∏:
${servicesText || "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è..."}

–ù–∞—à–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã:
${specialistsText || "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è..."}

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –î–õ–Ø –ü–ê–¶–ò–ï–ù–¢–û–í:

–ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏—ë–º:
- –ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É: ${clinicData.contacts?.phone_number || "—É—Ç–æ—á–Ω–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ"}
- –ß–µ—Ä–µ–∑ —Å–∞–π—Ç –∫–ª–∏–Ω–∏–∫–∏
- –õ–∏—á–Ω–æ –≤ –∫–ª–∏–Ω–∏–∫–µ –ø–æ –∞–¥—Ä–µ—Å—É: ${clinicData.contacts?.address || "—É—Ç–æ—á–Ω–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ"}

–ß—Ç–æ –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π –Ω–∞ –ø–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º:
- –ü–∞—Å–ø–æ—Ä—Ç –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç, —É–¥–æ—Å—Ç–æ–≤–µ—Ä—è—é—â–∏–π –ª–∏—á–Ω–æ—Å—Ç—å
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –∏ –∞–Ω–∞–ª–∏–∑–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
- –°–ø–∏—Å–æ–∫ –ø—Ä–∏–Ω–∏–º–∞–µ–º—ã—Ö –ª–µ–∫–∞—Ä—Å—Ç–≤
- –ú–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é –∫–∞—Ä—Ç—É –∏–∑ –¥—Ä—É–≥–æ–π –∫–ª–∏–Ω–∏–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)

–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø—Ä–∏—ë–º—É:
- –ù–∞ –£–ó–ò –æ—Ä–≥–∞–Ω–æ–≤ –±—Ä—é—à–Ω–æ–π –ø–æ–ª–æ—Å—Ç–∏ - –Ω–∞—Ç–æ—â–∞–∫ (–Ω–µ –µ—Å—Ç—å 6-8 —á–∞—Å–æ–≤)
- –ù–∞ –∞–Ω–∞–ª–∏–∑—ã –∫—Ä–æ–≤–∏ - –Ω–∞—Ç–æ—â–∞–∫ (–Ω–µ –µ—Å—Ç—å 8-12 —á–∞—Å–æ–≤)
- –ù–∞ –ø—Ä–∏—ë–º –∫ –≥–∏–Ω–µ–∫–æ–ª–æ–≥—É - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –≥–∏–≥–∏–µ–Ω–∞
- –ù–∞ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–∏—ë–º - –ø–æ—á–∏—Å—Ç–∏—Ç—å –∑—É–±—ã

–û–ø–ª–∞—Ç–∞:
- –ù–∞–ª–∏—á–Ω—ã–º–∏ –≤ –∫–∞—Å—Å–µ –∫–ª–∏–Ω–∏–∫–∏
- –ë–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç–æ–π
- –ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π

–ü–æ–º–Ω–∏: –µ—Å–ª–∏ –ø–∞—Ü–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ —Å–∏–º–ø—Ç–æ–º—ã –∏–ª–∏ –ª–µ—á–µ–Ω–∏–µ - –ù–ï –¥–∞–≤–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤, –∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–π –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.`;
}

export async function POST(request: NextRequest) {
  try {

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Prisma
    try {
      await prisma.$connect();
    } catch (dbError) {
    }

    if (!OPENROUTER_API_KEY) {
      return NextResponse.json(
        { error: "OpenRouter API key not configured. Please add OPENROUTER_API_KEY to your .env file." },
        {
          status: 500,
          headers: {
            'Cache-Control': 'no-store, no-cache, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0',
          }
        }
      );
    }

    const body = await request.json();

    const { messages } = body;

    if (!messages || !Array.isArray(messages)) {
      return NextResponse.json(
        { error: "Invalid messages format" },
        {
          status: 400,
          headers: {
            'Cache-Control': 'no-store, no-cache, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0',
          }
        }
      );
    }

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–ª–∏–Ω–∏–∫–∏
    const clinicData = await getClinicContext();

    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    const finalClinicData = clinicData || {
      contacts: {
        phone_number: "+375(29)161-01-01",
        email: "smartmedical.by@gmail.com",
        address: "–≥. –ú–∏–Ω—Å–∫, –ø—Ä. –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π, –¥. 119, –ø–æ–º. 504",
        work_hours_main: "–ü–Ω-–°–± 09:00-20:00",
        work_hours_sunday: "–í—Å 10:00-18:00",
      },
      services: [],
      specialists: [],
    };

    if (!clinicData) {
    }

    // –°–æ–∑–¥–∞—ë–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    const systemPrompt = buildSystemPrompt(finalClinicData);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ OpenRouter
    const response = await fetch(OPENROUTER_URL, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${OPENROUTER_API_KEY}`,
        "Content-Type": "application/json",
        "HTTP-Referer": process.env.NEXT_PUBLIC_SITE_URL || "http://localhost:3000",
        "X-Title": "Doctor Family Medical Clinic",
      },
      body: JSON.stringify({
        model: "openai/gpt-4o-mini",
        messages: [
          {
            role: "system",
            content: systemPrompt,
          },
          ...messages,
        ],
        temperature: 0.7,
        max_tokens: 500,
      }),
    });


    if (!response.ok) {
      const error = await response.text();
      return NextResponse.json(
        { error: `Failed to get response from AI: ${error.substring(0, 100)}` },
        {
          status: response.status,
          headers: {
            'Cache-Control': 'no-store, no-cache, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0',
          }
        }
      );
    }

    const data = await response.json();

    const assistantMessage = data.choices?.[0]?.message?.content;

    if (!assistantMessage) {
      return NextResponse.json(
        { error: "No response from AI" },
        {
          status: 500,
          headers: {
            'Cache-Control': 'no-store, no-cache, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0',
          }
        }
      );
    }

    const { message: cleanMessage, cards } = await parseCardsInMessage(assistantMessage);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–∞—Ä–∫–µ—Ä–∞ [NEED_OPERATOR]
    const needOperator = cleanMessage.includes("[NEED_OPERATOR]");

    // –£–¥–∞–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    let finalMessage = cleanMessage;
    cards.forEach((card) => {
      finalMessage = finalMessage.replace(card.placeholder, "");
    });

    // –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    finalMessage = finalMessage.replace("[NEED_OPERATOR]", "").trim();

    return NextResponse.json(
      {
        message: finalMessage,
        cards: cards,
        needOperator: needOperator,
      },
      {
        headers: {
          'Cache-Control': 'no-store, no-cache, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0',
        }
      }
    );
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : "Unknown error";
    return NextResponse.json(
      { error: `Internal server error: ${errorMessage}` },
      {
        status: 500,
        headers: {
          'Cache-Control': 'no-store, no-cache, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0',
        }
      }
    );
  }
}
